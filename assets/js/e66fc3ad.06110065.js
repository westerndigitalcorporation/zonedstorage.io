"use strict";(self.webpackChunkzonedstorage_io=self.webpackChunkzonedstorage_io||[]).push([[8875],{8159:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>c,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"applications/zenfs","title":"RocksDB with ZenFS","description":"RocksDB is a persistent","source":"@site/docs/applications/zenfs.md","sourceDirName":"applications","slug":"/applications/zenfs","permalink":"/docs/applications/zenfs","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"zenfs","title":"RocksDB with ZenFS","sidebar_label":"RocksDB with ZenFS"},"sidebar":"docs","previous":{"title":"Percona Server for MySQL","permalink":"/docs/applications/percona-server"},"next":{"title":"Overview","permalink":"/docs/tools"}}');var i=s(4848),r=s(8453);const c={id:"zenfs",title:"RocksDB with ZenFS",sidebar_label:"RocksDB with ZenFS"},a="RocksDB with ZenFS",o={},l=[{value:"Getting Started",id:"getting-started",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Building and Installing ZenFS",id:"building-and-installing-zenfs",level:3},{value:"ZenFS Command Line",id:"zenfs-command-line",level:3},{value:"Create a ZenFS file system",id:"create-a-zenfs-file-system",level:4},{value:"List files within a ZenFS file system",id:"list-files-within-a-zenfs-file-system",level:4},{value:"Back up files within a ZenFS file system",id:"back-up-files-within-a-zenfs-file-system",level:4},{value:"Restore files within a ZenFS file system",id:"restore-files-within-a-zenfs-file-system",level:4},{value:"Benchmarking",id:"benchmarking",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"rocksdb-with-zenfs",children:"RocksDB with ZenFS"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:(0,i.jsx)("a",{href:"https://rocksdb.org/",target:"_blank",children:"RocksDB"})})," is a persistent\nkey-value store for fast storage devices. It is implemented using a ",(0,i.jsx)("a",{href:"https://en.wikipedia.org/wiki/Log-structured_merge-tree",target:"_blank",children:"\nLog-Structured Merge-Tree (LSM-tree)"})," data structure.  It is simlilar to\nLSM-tree based key-value engine implementations: values are stored in tables\nthat are sorted in increasing key order. Tables are sequentially written and\nnever modified.  This basic principle of the LSM-tree data structure makes it\npossible to support zoned block devices."]}),"\n",(0,i.jsx)(n.p,{children:"The storage plugin architecture of RocksDB makes it possible to accommodate\ndifferent storage backends. More to the point, ZenFS implements support for\nzoned block devices and is integrated into RocksDB."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:(0,i.jsx)("a",{href:"https://github.com/westerndigitalcorporation/zenfs",target:"_blank",children:"\nZenFS"})})," is a file system plugin for ",(0,i.jsx)(n.em,{children:"RocksDB"})," that uses the ",(0,i.jsx)(n.em,{children:"RocksDB"}),'\nFileSystem [sic] interface to place files into zones on a raw zoned block\ndevice. By separating files into zones and utilizing "write lifetime hints"\n(WLTH) to co-locate data of similar lifetimes, ',(0,i.jsx)(n.em,{children:"ZenFS"})," can reduce system write\namplification as compared to regular file systems on conventional block\ndevices. ",(0,i.jsx)(n.em,{children:"ZenFS"})," ensures that there is no background garbage collection in the\nfile system or on the device, which improves performance in terms of\nthroughput, tail latencies and endurance."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"ZenFS"})," can store multiple files in a single zone by using an extent allocation\nscheme. A file can be composed of one or more extents and all the extents that\ncompose that file can be stored in the same zone (or in different zones) of the\ndevice. An extent never spans multiple zones. When all file extents in a zone\nare invalidated, the zone can be reset and then reused to store new file\nextents."]}),"\n",(0,i.jsx)(n.p,{children:"ZenFS places file extents into zones based on write lifetime hints (WLTH)\nprovided by RocksDB library. ZenFS always attempts to place file extents\ntogether in the same zones when they have similar WLTH."}),"\n",(0,i.jsxs)(n.p,{children:["In ",(0,i.jsx)(n.em,{children:"ZenFS"}),", data garbage collection is performed only by RocksDB when it\ninitiates the LSM-tree table compaction process. No garbage collection is\nexecuted by ZenFS and no garbage collection is executed by the ZNS device\ncontroller."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["Further information is available in\nthe ",(0,i.jsx)("a",{href:"https://www.usenix.org/conference/atc21/presentation/bjorling",target:"_blank",children:" ZNS: Avoiding the Block Interface Tax for Flash-based SSDs "}),"\nUSENIX ATC 2021 article."]})}),"\n",(0,i.jsx)(n.h2,{id:"getting-started",children:"Getting Started"}),"\n",(0,i.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"ZenFS"})," requires Linux kernel version 5.9 or newer. The kernel used must\nbe configured with\n",(0,i.jsx)(n.a,{href:"/docs/linux/config",children:"zoned block device support enabled"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"ZenFS"})," uses the ",(0,i.jsx)(n.a,{href:"/docs/tools/libzbd",children:(0,i.jsx)(n.em,{children:"libzbd"})})," library. The latest version\nof this library must be compiled and installed prior to building and\ninstalling ",(0,i.jsx)(n.em,{children:"ZenFS"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"building-and-installing-zenfs",children:"Building and Installing ZenFS"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"ZenFS"})," is embedded into RocksDB. It is available as a submodule in RocksDB\nand must be explicitly enabled when compiling RocksDB."]}),"\n",(0,i.jsxs)(n.p,{children:["Instructions that explain how to compile and install RocksDB with ",(0,i.jsx)(n.em,{children:"ZenFS"})," are\nmaintained in the ",(0,i.jsx)(n.em,{children:"ZenFS"})," project ",(0,i.jsx)("a",{href:"https://github.com/westerndigitalcorporation/zenfs/blob/master/README.md",target:"_blank",children:" README file"}),"."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:['Remember to set the block device IO scheduler to "deadline" to prevent write\noperations from being reordered. This can be done automatically on system\nboot using a ',(0,i.jsxs)(n.a,{href:"/docs/linux/sched",children:[(0,i.jsx)(n.em,{children:"udev"})," rule"]}),"."]})}),"\n",(0,i.jsx)(n.h3,{id:"zenfs-command-line",children:"ZenFS Command Line"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"ZenFS"})," provides a command line utility called ",(0,i.jsx)(n.em,{children:"zenfs"}),". This utility is used to\nformat the zoned device to create a new filesystem, to list the files, and to\nback up and restore the filesystem."]}),"\n",(0,i.jsx)(n.h4,{id:"create-a-zenfs-file-system",children:"Create a ZenFS file system"}),"\n",(0,i.jsxs)(n.p,{children:["To create or format a zoned block device (e.g., NVMe ZNS device ",(0,i.jsx)(n.code,{children:"/dev/nvme0n1"}),"),\nuse the following command:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-plaintext",children:"zenfs mkfs --zbd=nvme0n1 --aux_path=/tmp/zone-aux --force\n\n# Output example\nZenFS file system created. Free space: 220246 MB\n"})}),"\n",(0,i.jsx)(n.h4,{id:"list-files-within-a-zenfs-file-system",children:"List files within a ZenFS file system"}),"\n",(0,i.jsxs)(n.p,{children:["After the zoned block device has been formatted, ",(0,i.jsx)(n.em,{children:"RocksDB"})," manages its files\nthrough ",(0,i.jsx)(n.em,{children:"ZenFS"}),". To list the files present on the zoned block device, use the\nfollowing command:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-plaintext",children:"zenfs list --zbd=nvme0n1 --path=rocksdbtest/dbbench\n\n# Output example:\n           0    Jul 20 2021 18:13:52            LOCK\n       66979    Jul 20 2021 18:14:01            LOG\n    26961453    Jul 20 2021 18:13:55            000014.sst\n    26961524    Jul 20 2021 18:13:55            000015.sst\n    26961904    Jul 20 2021 18:13:55            000016.sst\n    26963148    Jul 20 2021 18:13:55            000017.sst\n   102734225    Jul 20 2021 18:13:56            000019.sst\n    26962608    Jul 20 2021 18:13:55            000020.sst\n    26961566    Jul 20 2021 18:13:56            000021.sst\n    26963214    Jul 20 2021 18:13:56            000022.sst\n    26963380    Jul 20 2021 18:13:57            000023.sst\n   102594916    Jul 20 2021 18:13:58            000025.sst\n    26546055    Jul 20 2021 18:13:59            000026.sst\n   102540090    Jul 20 2021 18:14:00            000028.sst\n   190808702    Jul 20 2021 18:14:01            000029.log\n   102826791    Jul 20 2021 18:14:00            000030.sst\n          16    Jul 20 2021 18:13:52            CURRENT\n          37    Jul 20 2021 18:13:52            IDENTITY\n        1586    Jul 20 2021 18:14:01            MANIFEST-000004\n        6178    Jul 20 2021 18:13:52            OPTIONS-000007\n"})}),"\n",(0,i.jsx)(n.h4,{id:"back-up-files-within-a-zenfs-file-system",children:"Back up files within a ZenFS file system"}),"\n",(0,i.jsxs)(n.p,{children:["To back up all table and metadata files within a ",(0,i.jsx)(n.em,{children:"ZenFS"})," file system to a local\nfilesystem, use the following command:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-plaintext",children:"zenfs backup --zbd=nvme0n1 --path=/tmp/backup\n\n# Output example\nrocksdbtest/dbbench/LOCK\nrocksdbtest/dbbench/LOG\nrocksdbtest/dbbench/000014.sst\nrocksdbtest/dbbench/000015.sst\nrocksdbtest/dbbench/000016.sst\nrocksdbtest/dbbench/000017.sst\nrocksdbtest/dbbench/000019.sst\nrocksdbtest/dbbench/000020.sst\nrocksdbtest/dbbench/000021.sst\nrocksdbtest/dbbench/000022.sst\nrocksdbtest/dbbench/000023.sst\nrocksdbtest/dbbench/000025.sst\nrocksdbtest/dbbench/000026.sst\nrocksdbtest/dbbench/000028.sst\nrocksdbtest/dbbench/000029.log\nrocksdbtest/dbbench/000030.sst\nrocksdbtest/dbbench/CURRENT\nrocksdbtest/dbbench/IDENTITY\nrocksdbtest/dbbench/MANIFEST-000004\nrocksdbtest/dbbench/OPTIONS-000007\n"})}),"\n",(0,i.jsx)(n.h4,{id:"restore-files-within-a-zenfs-file-system",children:"Restore files within a ZenFS file system"}),"\n",(0,i.jsx)(n.p,{children:"To restore files from a previous backup, use the following command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-plaintext",children:"zenfs restore --zbd=nvme0n1 --path=/tmp/backup/rocksdbtest/dbbench/ \\\n\t\t--restore_path=rocksdbtest/dbbench\n\n# Output example\n/tmp/backup/rocksdbtest/dbbench/CURRENT\n/tmp/backup/rocksdbtest/dbbench/LOCK\n/tmp/backup/rocksdbtest/dbbench/000015.sst\n/tmp/backup/rocksdbtest/dbbench/000022.sst\n/tmp/backup/rocksdbtest/dbbench/LOG\n/tmp/backup/rocksdbtest/dbbench/MANIFEST-000004\n/tmp/backup/rocksdbtest/dbbench/000023.sst\n/tmp/backup/rocksdbtest/dbbench/000028.sst\n/tmp/backup/rocksdbtest/dbbench/000025.sst\n/tmp/backup/rocksdbtest/dbbench/000030.sst\n/tmp/backup/rocksdbtest/dbbench/IDENTITY\n/tmp/backup/rocksdbtest/dbbench/OPTIONS-000007\n/tmp/backup/rocksdbtest/dbbench/000020.sst\n/tmp/backup/rocksdbtest/dbbench/000019.sst\n/tmp/backup/rocksdbtest/dbbench/000016.sst\n/tmp/backup/rocksdbtest/dbbench/000014.sst\n/tmp/backup/rocksdbtest/dbbench/000026.sst\n/tmp/backup/rocksdbtest/dbbench/000029.log\n/tmp/backup/rocksdbtest/dbbench/000021.sst\n/tmp/backup/rocksdbtest/dbbench/000017.sst\n"})}),"\n",(0,i.jsx)(n.h3,{id:"benchmarking",children:"Benchmarking"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"RocksDB"})," provides the ",(0,i.jsx)(n.em,{children:"db_bench"})," utility to test and benchmark the performance\nof a device. The following command provides an example of ",(0,i.jsx)(n.em,{children:"db_bench"})," execution,\nusing a zoned block device that has been formatted with ",(0,i.jsx)(n.em,{children:"ZenFS"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-plaintext",children:"db_bench --fs_uri=zenfs://dev:nvme0n1 --benchmarks=fillrandom \\\n\t   --use_direct_reads --key_size=16 --value_size=800 \\\n\t   --target_file_size_base=2147483648 \\\n\t   --use_direct_io_for_flush_and_compaction \\\n\t   --max_bytes_for_level_multiplier=4 --write_buffer_size=2147483648 \\\n\t   --target_file_size_multiplier=1 --num=1000000 --threads=2 \\\n\t   --max_background_jobs=4\n\n# Output example\nInitializing RocksDB Options from the specified file\nInitializing RocksDB Options from command-line flags\nRocksDB:    version 6.21\nDate:       Tue Jul 20 20:24:56 2021\nCPU:        32 * AMD EPYC 7302P 16-Core Processor\nCPUCache:   512 KB\nKeys:       16 bytes each (+ 0 bytes user-defined timestamp)\nValues:     800 bytes each (400 bytes after compression)\nEntries:    1000000\nPrefix:    0 bytes\nKeys per prefix:    0\nRawSize:    778.2 MB (estimated)\nFileSize:   396.7 MB (estimated)\nWrite rate: 0 bytes/second\nRead rate: 0 ops/second\nCompression: Snappy\nCompression sampling rate: 0\nMemtablerep: skip_list\nPerf Level: 1\n------------------------------------------------\nInitializing RocksDB Options from the specified file\nInitializing RocksDB Options from command-line flags\nDB path: [rocksdbtest/dbbench]\nfillrandom   :      10.447 micros/op 191441 ops/sec;  149.0 MB/s\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>a});var t=s(6540);const i={},r=t.createContext(i);function c(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);