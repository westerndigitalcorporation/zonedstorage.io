"use strict";(self.webpackChunkzonedstorage_io=self.webpackChunkzonedstorage_io||[]).push([[4186],{2336:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>o,toc:()=>c});var t=s(5893),i=s(1151);const d={id:"blktests",title:"Kernel Block Layer Tests",sidebar_label:"Kernel Block Layer Tests"},l="Kernel Block Layer Tests",o={id:"tests/blktests",title:"Kernel Block Layer Tests",description:"blktests is a test suite for Linux;reg; kernel storage stack, that is, the",source:"@site/docs/tests/blktests.md",sourceDirName:"tests",slug:"/tests/blktests",permalink:"/docs/tests/blktests",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{id:"blktests",title:"Kernel Block Layer Tests",sidebar_label:"Kernel Block Layer Tests"},sidebar:"docs",previous:{title:"ZBC/ZAC Compliance Tests",permalink:"/docs/tests/zbc-tests"},next:{title:"Overview",permalink:"/docs/benchmarking"}},r={},c=[{value:"Overview",id:"overview",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Execution",id:"execution",level:2},{value:"Full Run",id:"full-run",level:3},{value:"Quick Run",id:"quick-run",level:3}];function a(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"kernel-block-layer-tests",children:"Kernel Block Layer Tests"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.em,{children:"blktests"})," is a test suite for Linux;reg; kernel storage stack, that is, the\nblock I/O layer as well as underlying device specific layers (SCSI, NVMe, SRP,\netc). ",(0,t.jsx)(n.em,{children:"blktests"})," is heavily inspired by the ",(0,t.jsx)(n.em,{children:"xfstests"})," framework for testing\nfile systems."]}),"\n",(0,t.jsxs)(n.p,{children:["Recent contributions to ",(0,t.jsx)(n.em,{children:"blktests"})," added zoned block device tests support."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.em,{children:"blktests"})," project is hosted on\n",(0,t.jsx)(n.a,{href:"https://github.com/osandov/blktests",children:"GitHub"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.em,{children:"blktests"})," organizes test cases into groups. The test groups currently available\nare as shown in the table below."]}),"\n",(0,t.jsx)("center",{children:(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"Group name"}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"block"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Block layer generic tests"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"loop"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Loopback device tests"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"meta"})}),(0,t.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,t.jsx)(n.em,{children:"blktests"})," self tests"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"nbd"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Network block device driver tests"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"nvme"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"NVMe driver tests"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"nvmeof-mp"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"NVME-over-fabrics multipath tests"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"scsi"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"SCSI layer tests"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"srp"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"SCSI RDMA Protocol driver tests"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"zbd"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Zoned block device tests"})]})]})]})}),"\n",(0,t.jsxs)(n.p,{children:["The test groups supporting zoned block devices are ",(0,t.jsx)(n.em,{children:"block"})," and ",(0,t.jsx)(n.em,{children:"zbd"}),".\n",(0,t.jsx)(n.a,{href:"/docs/tools/util-linux#blkzone",children:(0,t.jsx)(n.em,{children:"blkzone"})})," and ",(0,t.jsx)(n.a,{href:"/docs/benchmarking/fio/overview",children:(0,t.jsx)(n.em,{children:"fio"})}),"\nversion 3.9 or higher must be installed for executing these test groups."]}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(n.p,{children:["Detailed generic information on how to configure and run ",(0,t.jsx)(n.em,{children:"blktests"})," is\nprovided ",(0,t.jsx)("a",{href:"https://github.com/osandov/blktests/blob/master/Documentation/running-tests.md",target:"_blank",children:"here"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["For executing tests against a physical zoned block device (e.g. a ZBC/ZAC disk),\nthe following ",(0,t.jsx)(n.code,{children:"config"})," file should be prepared and copied to the ",(0,t.jsx)(n.em,{children:"blktests"}),"\ninstallation directory. Tests can also be executed directly from the source\ndirectory if the ",(0,t.jsx)(n.code,{children:"config"})," file is copied in that location."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Tests target device list\nTEST_DEVS=(/dev/sdd)\n\n# Enable zoned block device mode for the block group genertic tests \nRUN_ZONED_TESTS=1\n"})}),"\n",(0,t.jsxs)(n.p,{children:["With this configuration, all tests relevant to zoned block devices will be\nexecuted. The execution duration can be several 10s of minutes depending on the\ntarget device and host system. To Shorten execution, the options ",(0,t.jsx)(n.code,{children:"TIMEOUT"})," and\n",(0,t.jsx)(n.code,{children:"QUICK_RUN"})," can be added to the configuration."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Tests target device list\nTEST_DEVS=(/dev/sdd)\n\n# Enable zoned block device mode for the block group genertic tests\nRUN_ZONED_TESTS=1\n\n# Speed up execution (weaker tests)\nQUICK_RUN=1\nTIMEOUT=30\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Of note is that the block layer generic tests of the ",(0,t.jsx)(n.em,{children:"block"})," group also include\ntest cases executed against a logical device (",(0,t.jsx)(n.em,{children:"null_blk"})," block device). These\ntests are executed twice, once with the ",(0,t.jsx)(n.em,{children:"null_blk"})," device configured as a\nregular block device and a second time with the ",(0,t.jsx)(n.em,{children:"null_blk"})," device configured as\na zoned block device. To reduce the test cases execution to only the physical\ndevice specified in the configuration file, the ",(0,t.jsx)(n.code,{children:"DEVICE_ONLY"})," option can be set."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Tests target device list\nTEST_DEVS=(/dev/sdd)\n\n# Enable zoned block device mode for the block group genertic tests\nRUN_ZONED_TESTS=1\n\n# Speed up execution (weaker tests)\nQUICK_RUN=1\nTIMEOUT=30\n\n# Exercise only the devices in TEST_DEVS\nDEVICE_ONLY=1\n"})}),"\n",(0,t.jsx)(n.h2,{id:"execution",children:"Execution"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.em,{children:"blktests"})," execution is done using the ",(0,t.jsx)(n.code,{children:"check"})," script present in the top level\ndirectory. This script optionally takes as argument a list of test groups or\ntest cases to execute. Bu default, without any argument, all test groups will be\nexecuted."]}),"\n",(0,t.jsxs)(n.p,{children:["For zoned block device tests, executing the test cases of the ",(0,t.jsx)(n.em,{children:"block"})," and ",(0,t.jsx)(n.em,{children:"zbd"}),"\ntest groups is sufficient."]}),"\n",(0,t.jsxs)(n.p,{children:["As discussed in the ",(0,t.jsx)(n.a,{href:"#configuration",children:"configuration"})," section above, several\noptions can speedup the execution of ",(0,t.jsx)(n.em,{children:"blktests"}),". Such quick runs are indeed\nfaster but at the cost of weaker testing compared to full runs."]}),"\n",(0,t.jsx)(n.h3,{id:"full-run",children:"Full Run"}),"\n",(0,t.jsxs)(n.p,{children:["The following command executes all test cases relevant to zoned block devices\nwith the device specified in the ",(0,t.jsx)(n.code,{children:"config"})," configuration file as target. In this\nexample, no options are added."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-plaintext",children:"# ./check block zbd\nblock/001 (stress device hotplugging)                        [passed]\n    runtime  120.013s  ...  123.440s\nblock/002 (remove a device while running blktrace)           [passed]\n    runtime  0.741s  ...  0.761s\nblock/003 => sdd (run various discard sizes)                 [not run]\n    /dev/sdd is a zoned block device\nblock/004 => sdd (run lots of flushes)                       [passed]\n    runtime     98.876s  ...  82.665s\n    write iops  170      ...  203\nblock/005 => sdd (switch schedulers while doing IO)          [passed]\n    read iops  1415    ...  791\n    runtime    6.765s  ...  11.242s\nblock/006 (run null-blk in blocking mode)                    [passed]\n    read iops  154220   ...  152356\n    runtime    19.158s  ...  19.229s\nblock/006 (zoned) (run null-blk in blocking mode)            [passed]\n    read iops  150692   ...  146826\n    runtime    19.128s  ...  19.720s\nblock/007 => sdd (test classic and hybrid IO polling)        [not run]\n    /dev/sdd is a zoned block device\nblock/008 (do IO while hotplugging CPUs)                     [not run]\n    CPU hotplugging is not supported\nblock/009 (check page-cache coherency after BLKDISCARD)      [passed]\n    runtime  0.827s  ...  0.868s\nblock/010 (run I/O on null_blk with shared and non-shared tags) [passed]\n    Individual tags read iops  254661    ...  253371\n    Shared tags read iops      174876    ...  174933\n    runtime                    695.714s  ...  715.579s\nblock/010 (zoned) (run I/O on null_blk with shared and non-shared tags) [passed]\n    Individual tags read iops  253356    ...  252487\n    Shared tags read iops      174871    ...  174780\n    runtime                    667.479s  ...  652.577s\nblock/011 => sdd (disable PCI device while doing I/O)        [passed]\n    runtime  8.293s  ...  17.760s\nblock/012 => sdd (check that a read-only block device fails writes) [not run]\n    /dev/sdd is a zoned block device\nblock/013 => sdd (try BLKRRPART on a mounted device)         [not run]\n    /dev/sdd is a zoned block device\nblock/014 (run null-blk with blk-mq and timeout injection configured) [not run]\n    null_blk module does not have parameter timeout\nblock/015 (run null-blk on different schedulers with requeue injection configured) [not run]\n    null_blk module does not have parameter requeue\nblock/016 (send a signal to a process waiting on a frozen queue) [passed]\n    runtime  8.055s  ...  8.055s\nblock/016 (zoned) (send a signal to a process waiting on a frozen queue) [passed]\n    runtime  8.055s  ...  8.055s\nblock/017 (do I/O and check the inflight counter)            [passed]\n    runtime  1.691s  ...  1.675s\nblock/017 (zoned) (do I/O and check the inflight counter)    [passed]\n    runtime  1.690s  ...  1.692s\nblock/018 (do I/O and check iostats times)                   [passed]\n    runtime  5.075s  ...  5.077s\nblock/019 => sdd (break PCI link device while doing I/O)     [not run]\n    /dev/sdd is a zoned block device\nblock/020 (run null-blk on different schedulers with only one hardware tag) [passed]\n    runtime  43.139s  ...  43.191s\nblock/020 (zoned) (run null-blk on different schedulers with only one hardware tag) [passed]\n    runtime  43.120s  ...  43.206s\nblock/021 (read/write nr_requests on null-blk with different schedulers) [passed]\n    runtime  1.396s  ...  1.393s\nblock/021 (zoned) (read/write nr_requests on null-blk with different schedulers) [passed]\n    runtime  1.399s  ...  1.419s\nblock/023 (do I/O on all null_blk queue modes)               [passed]\n    runtime  0.276s  ...  0.280s\nblock/023 (zoned) (do I/O on all null_blk queue modes)       [passed]\n    runtime  0.279s  ...  0.302s\nblock/024 (do I/O faster than a jiffy and check iostats times) [passed]\n    runtime  4.902s  ...  4.904s\nblock/025 (do a huge discard with 4k sector size)            [passed]\n    runtime  8.869s  ...  8.921s\nblock/027 (stress device hotplugging with running fio jobs and different schedulers) [not run]\n    no support for io cgroup controller; if it is enabled, you may need to boot with cgroup_no_v1=io\nblock/028 (do I/O on scsi_debug with DIF/DIX enabled)        [passed]\n    runtime  19.924s  ...  19.942s\nzbd/001 => sdd (sysfs and ioctl)                             [passed]\n    runtime    ...  0.706s\nzbd/002 => sdd (report zone)                                 [passed]\n    runtime    ...  6.534s\nzbd/003 => sdd (reset sequential required zones)             [passed]\n    runtime    ...  13.324s\nzbd/004 => sdd (write split across sequential zones)         [passed]\n    runtime    ...  17.019s\nzbd/005 => sdd (write command ordering)                      [passed]\n    runtime       ...  178.335s\n    write io      ...  7196672\n    write iops    ...  933\nzbd/006 => sdd (revalidate)                                  [passed]\n    runtime       ...  61.028s\n    write io      ...  1805004\n    write iops    ...  15041\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The output of some tests is ",(0,t.jsx)(n.em,{children:"[not run]"}),". This is not a failure. This only\nindicates that the target device specified in the configuration file does not\nsupport the feature being tested. For example, in the above run, test case\n",(0,t.jsx)(n.em,{children:"block/003"})," is not executed against the specified host managed disk because the\ndisk does not support the ",(0,t.jsx)(n.em,{children:"discard"})," command."]}),"\n",(0,t.jsx)(n.h3,{id:"quick-run",children:"Quick Run"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.em,{children:"blkltests"})," execution can be accelerated using the ",(0,t.jsx)(n.code,{children:"TIMEOUT"}),", ",(0,t.jsx)(n.code,{children:"QUICK_RUN"})," and\n",(0,t.jsx)(n.code,{children:"DEVICE_ONLY"})," configuration options."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Tests target device list\nTEST_DEVS=(/dev/sdd)\n\n# Enable zoned block device mode for the block group genertic tests\nRUN_ZONED_TESTS=1\n\n# Speed up execution (weaker tests)\nQUICK_RUN=1\nTIMEOUT=30\n\n# Exercise only the devices in TEST_DEVS\nDEVICE_ONLY=1\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Running only the ",(0,t.jsx)(n.em,{children:"block"})," and ",(0,t.jsx)(n.em,{children:"zbd"})," test groups with the above configuration\ngives the following results."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-plaintext",children:"# ./check block zbd\nblock/003 => sdd (run various discard sizes)                 [not run]\n    /dev/sdd is a zoned block device\nblock/004 => sdd (run lots of flushes)                       [passed]\n    runtime     913.097s  ...  33.714s\n    write iops            ...  239\nblock/005 => sdd (switch schedulers while doing IO)          [passed]\n    read iops  2975     ...  3573\n    runtime    22.510s  ...  19.194s\nblock/007 => sdd (test classic and hybrid IO polling)        [not run]\n    /dev/sdd is a zoned block device\nblock/008 => sdd (do IO while hotplugging CPUs)              [not run]\n    /dev/sdd is a zoned block device\nblock/011 => sdd (disable PCI device while doing I/O)        [passed]\n    runtime    ...  30.322s\nblock/012 => sdd (check that a read-only block device fails writes) [not run]\n    /dev/sdd is a zoned block device\nblock/013 => sdd (try BLKRRPART on a mounted device)         [not run]\n    /dev/sdd is a zoned block device\nblock/019 => sdd (break PCI link device while doing I/O)     [not run]\n    /dev/sdd is a zoned block device\nzbd/001 => sdd (sysfs and ioctl)                             [passed]\n    runtime  1.328s  ...  0.521s\nzbd/003 => sdd (reset sequential required zones)             [passed]\n    runtime  9.591s  ...  11.008s\nzbd/004 => sdd (write split across sequential zones)         [passed]\n    runtime  11.772s  ...  11.743s\nzbd/005 => sdd (write command ordering)                      [passed]\n    runtime     59.688s  ...  167.521s\n    write io    7201536  ...  7113472\n    write iops  933      ...  921\nzbd/006 => sdd (revalidate)                                  [passed]\n    runtime     7.063s  ...  39.464s\n    write io            ...  2097152\n    write iops          ...  48971\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},1151:(e,n,s)=>{s.d(n,{Z:()=>o,a:()=>l});var t=s(7294);const i={},d=t.createContext(i);function l(e){const n=t.useContext(d);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(d.Provider,{value:n},e.children)}}}]);