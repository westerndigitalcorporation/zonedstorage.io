"use strict";(self.webpackChunkzonedstorage_io=self.webpackChunkzonedstorage_io||[]).push([[1968],{8060:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>f,frontMatter:()=>t,metadata:()=>r,toc:()=>c});var o=s(7624),i=s(4552);const t={id:"f2fs",title:"f2fs",sidebar_label:"f2fs"},a="f2fs File System",r={id:"filesystems/f2fs",title:"f2fs",description:"The Flash-Friendly File System (f2fs) was designed on the basis of a",source:"@site/docs/filesystems/f2fs.md",sourceDirName:"filesystems",slug:"/filesystems/f2fs",permalink:"/docs/filesystems/f2fs",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{id:"f2fs",title:"f2fs",sidebar_label:"f2fs"},sidebar:"docs",previous:{title:"btrfs",permalink:"/docs/filesystems/btrfs"},next:{title:"zonefs",permalink:"/docs/filesystems/zonefs"}},l={},c=[{value:"Usage",id:"usage",level:2},{value:"Implementation",id:"implementation",level:2},{value:"Zoned Block Device Support",id:"zoned-block-device-support",level:3},{value:"Zone Capacity Support",id:"zone-capacity-support",level:3},{value:"Limitations",id:"limitations",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.M)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"f2fs-file-system",children:"f2fs File System"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.em,{children:"Flash-Friendly File System"})," (",(0,o.jsx)(n.em,{children:"f2fs"}),') was designed on the basis of a\nlog-structured file system approach, but was modified to avoid the classical\nproblems of the traditional log-structured approach (e.g. the snowball effect\nof "wandering trees" and the high "cleaning overhead").']}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.em,{children:"f2fs"})," supports various parameters not only for configuring on-disk layout but\nalso for selecting allocation and cleaning algorithms."]}),"\n",(0,o.jsx)(n.admonition,{title:"System Requirements",type:"note",children:(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Linux kernel: 5.12+ (for SMR) or 5.16+ (for SSD /w ZNS support)."}),"\n",(0,o.jsx)(n.li,{children:"f2fs-tools: 1.12+ (for SMR) or 1.14+ (for SSD /w ZNS support)."}),"\n",(0,o.jsxs)(n.li,{children:["I/O scheduler: ",(0,o.jsx)(n.a,{href:"/docs/linux/sched#block-io-scheduler-configuration",children:"mq-deadline to be configured for the block device"}),"."]}),"\n"]})}),"\n",(0,o.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,o.jsxs)(n.p,{children:["To format a zoned block device, ",(0,o.jsx)(n.em,{children:"that has conventional zones"}),", with ",(0,o.jsx)(n.em,{children:"mkfs.f2fs"}),", the option ",(0,o.jsx)(n.code,{children:"-m"})," must be\nspecified:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-plaintext",children:'# mkfs.f2fs -m /dev/sdb\n\n\tf2fs-tools: mkfs.f2fs Ver: 1.12.0 (2018-11-12)\n\nInfo: Disable heap-based policy\nInfo: Debug level = 0\nInfo: Trim is enabled\nInfo: [/dev/sdb] Disk Model: HGST HSH721415AL\nInfo: Host-managed zoned block device:\n      55880 zones, 524 randomly writeable zones\n      65536 blocks per zone\nInfo: Segments per section = 128\nInfo: Sections per zone = 1\nInfo: sector size = 4096\nInfo: total sectors = 3662151680 (14305280 MB)\nInfo: zone aligned segment0 blkaddr: 65536\nInfo: format version with\n  "Linux version 5.0.16-300.fc30.x86_64 (mockbuild@bkernel03.phx2.fedoraproject.org) (gcc version 9.1.1 20190503 (Red Hat 9.1.1-1) (GCC)) #1 SMP Tue May 14 19:33:09 UTC 2019"\nInfo: [/dev/sdb] Discarding device\nInfo: Discarded 14305280 MB\nInfo: Overprovision ratio = 0.600%\nInfo: Overprovision segments = 86254 (GC reserved = 43690)\nInfo: format successful\n'})}),"\n",(0,o.jsx)(n.p,{children:"The formatted zoned block device can now be directly mounted. No further\nsetup is necessary:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-plaintext",children:"# mount /dev/sdb /mnt\n"})}),"\n",(0,o.jsxs)(n.p,{children:["If the zoned block device, ",(0,o.jsx)(n.em,{children:"does not have conventional zones"}),", then a regular\nblock device can be used for f2fs' metadata.\nIt is formatted by using the ",(0,o.jsx)(n.em,{children:"-c"})," option of ",(0,o.jsx)(n.em,{children:"mkfs.f2fs"})," as shown in the following example:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-plaintext",children:"# mkfs.f2fs -f -m -c /dev/nvme1n1 /dev/nvme0n1\n\n        F2FS-tools: mkfs.f2fs Ver: 1.14.0 (2021-06-23)\n\nInfo: Disable heap-based policy\nInfo: Debug level = 0\nInfo: Trim is enabled\nInfo: Host-managed zoned block device:\n      2048 zones, 0 randomly writeable zones\n      524288 blocks per zone\nInfo: Segments per section = 1024\nInfo: Sections per zone = 1\nInfo: sector size = 4096\nInfo: total sectors = 1107296256 (4325376 MB)\nInfo: zone aligned segment0 blkaddr: 524288\nInfo: format version with\n  \"Linux version 5.13.0-rc6+ (user1@brahmaputra) (gcc (Ubuntu 10.3.0-1ubuntu1) 10.3.0, GNU ld (GNU Binutils for Ubuntu) 2.36.1) #2 SMP Fri Jun 18 16:45:29 IST 2021\"\nInfo: [/dev/nvme0n1] Discarding device\nInfo: This device doesn't support BLKSECDISCARD\nInfo: This device doesn't support BLKDISCARD\nInfo: [/dev/nvme1n1] Discarding device\nInfo: Discarded 4194304 MB\nInfo: Overprovision ratio = 3.090%\nInfo: Overprovision segments = 74918 (GC reserved = 40216)\nInfo: format successful\n"})}),"\n",(0,o.jsxs)(n.p,{children:["In the above command, ",(0,o.jsx)(n.code,{children:"/dev/nvme1n1"})," is the block device file of the zoned\nnamespace that will be used for the ",(0,o.jsx)(n.em,{children:"f2fs"})," volume, and ",(0,o.jsx)(n.code,{children:"/dev/nvme0n1"}),"is the namespace\nused for the ",(0,o.jsx)(n.em,{children:"f2fs"})," metadata."]}),"\n",(0,o.jsx)(n.p,{children:"To mount the volume formatted with the above command, the regular block device\nmust be specified:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-plaintext",children:"# mount -t f2fs /dev/nvme0n1 /mnt/f2fs/\n"})}),"\n",(0,o.jsx)(n.h2,{id:"implementation",children:"Implementation"}),"\n",(0,o.jsx)(n.h3,{id:"zoned-block-device-support",children:"Zoned Block Device Support"}),"\n",(0,o.jsxs)(n.p,{children:["Zoned block device support was added to ",(0,o.jsx)(n.em,{children:"f2fs"})," with kernel 4.10. Because ",(0,o.jsx)(n.em,{children:"f2fs"}),"\nuses a metadata-block on-disk format with fixed-block location, only zoned\nblock devices that include conventional zones are supported. Zoned devices\ncomposed entirely of sequential zones cannot be used with ",(0,o.jsx)(n.em,{children:"f2fs"})," as a\nstandalone device and they require a multi-device setup in order to place\nmetadata blocks on randomly writable storage. ",(0,o.jsx)(n.em,{children:"f2fs"})," supports multi-device\nsetup where multiple block device address spaces are linearly concatenated to\nform a logically larger block device. The ",(0,o.jsx)(n.a,{href:"/docs/linux/dm#dm-linear",children:(0,o.jsx)(n.em,{children:"dm-linear"})}),"\ndevice mapper target can also be used to create a logical device that is\ncomposed of both conventional zones and sequential zones suitable for ",(0,o.jsx)(n.em,{children:"f2fs"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.em,{children:"f2fs"})," zoned block device support was achieved using the following principles."]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Section Alignment"})," In ",(0,o.jsx)(n.em,{children:"f2fs"}),", a section is a group of fixed-size\nsegments (2 MB). The number of segments in a section is determined to match\nthe zoned device zone size. For example: with a 256 MB zone size, a section\ncontains 128 segments of 2MB."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Forced LFS mode"})," By default, ",(0,o.jsx)(n.em,{children:"f2fs"})," tries to optimize block allocation\n(in order to avoid excessive append write) by allowing some random writes\nwithin segments. The LFS mode forces sequential writes to segments and\nforces the sequential use of segments within sections, which results in\nfull compliance with the zoned block device's write constraint."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Zone reset as discard operation"})," In the past, block ",(0,o.jsx)(n.em,{children:"discard"})," (or ",(0,o.jsx)(n.em,{children:"trim"}),')\nindicated to a device that a block or range of blocks are no longer in use.\nThis has been replaced with the execution of a "zone write pointer reset"\ncommand when all blocks of all segments of a section are free. This allows\nthe section to be reused.']}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Compared to a solution that uses the ",(0,o.jsx)(n.em,{children:"dm-zoned"})," device mapper target,\nthe performance of ",(0,o.jsx)(n.em,{children:"f2fs"}),' on zoned devices does not suffer from "zone reclaim\noverhead", because writes are always sequential and do not require on-disk\ntemporary buffering. ',(0,o.jsx)(n.em,{children:"f2fs"})," garbage collection (segment cleanup) generates\noverhead only for workloads that frequently delete files or modify files' data."]}),"\n",(0,o.jsx)(n.h3,{id:"zone-capacity-support",children:"Zone Capacity Support"}),"\n",(0,o.jsxs)(n.p,{children:["SSDs with Zoned Namespace support can have a per ",(0,o.jsx)(n.a,{href:"/docs/introduction/zns#zone-capacity-and-zone-size",children:"zone capacity that is smaller than the zone\nsize"}),". To support such\ndevices, ",(0,o.jsx)(n.em,{children:"f2fs"})," ensures that block allocation and accounting considers only the\nblocks in a zone that are within the zone's capacity. This support for\nzone capacity has been available since it was introduced in Linux kernel version\n5.10."]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.em,{children:"f2fs"})," volumes need some storage space that is randomly writable in order\nto store and update in-place metadata blocks for the volume. Since NVMe zoned\nnamespaces do not have conventional zones, a ",(0,o.jsx)(n.em,{children:"f2fs"})," volume cannot be\nself-contained within a single NVMe zoned namespace. To format an ",(0,o.jsx)(n.em,{children:"f2fs"})," volume\nusing a NVMe zoned namespace, a multi-device volume format must be used in order\nto provide an additional regular block device to store the volume metadata\nblocks. This additional regular block device can be either a regular namespace\non the same NVMe device or a regular namespace on another NVMe device."]}),"\n",(0,o.jsx)(n.h3,{id:"limitations",children:"Limitations"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.em,{children:"f2fs"})," uses 32-bit block numbers with a block size of 4 KB. This results in a\nmaximum volume size of 16 TB. Any device or combination of devices (for a\nmulti-device volume) with a total capacity that is larger than 16 TB cannot\nbe used with ",(0,o.jsx)(n.em,{children:"f2fs"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["To overcome this limit, the ",(0,o.jsx)(n.a,{href:"/docs/linux/dm#dm-linear",children:(0,o.jsx)(n.em,{children:"dm-linear"})})," device\nmapper target can be used to partition a zoned block device into serviceable,\nsmaller logical devices. This configuration must ensure that each logical device\nthat is created is assigned a sufficient amount of conventional zones to store\n",(0,o.jsx)(n.em,{children:"f2fs"})," fixed location metadata blocks."]})]})}function f(e={}){const{wrapper:n}={...(0,i.M)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},4552:(e,n,s)=>{s.d(n,{I:()=>r,M:()=>a});var o=s(1504);const i={},t=o.createContext(i);function a(e){const n=o.useContext(t);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),o.createElement(t.Provider,{value:n},e.children)}}}]);