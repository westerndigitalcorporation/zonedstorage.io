<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-linux/sched" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Write Ordering Control | Zoned Storage</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zonedstorage.io/docs/linux/sched"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Write Ordering Control | Zoned Storage"><meta data-rh="true" name="description" content="Historically, the Linux&amp;reg; kernel block I/O stack (i.e., the block layer and"><meta data-rh="true" property="og:description" content="Historically, the Linux&amp;reg; kernel block I/O stack (i.e., the block layer and"><link data-rh="true" rel="icon" href="/img/zs-logo.ico"><link data-rh="true" rel="canonical" href="https://zonedstorage.io/docs/linux/sched"><link data-rh="true" rel="alternate" href="https://zonedstorage.io/docs/linux/sched" hreflang="en"><link data-rh="true" rel="alternate" href="https://zonedstorage.io/docs/linux/sched" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Write Ordering Control","item":"https://zonedstorage.io/docs/linux/sched"}]}</script><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0DX1KGD5E4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0DX1KGD5E4",{})</script><link rel="stylesheet" href="/assets/css/styles.0fff285b.css">
<script src="/assets/js/runtime~main.6ff41505.js" defer="defer"></script>
<script src="/assets/js/main.69b7e4e5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Zoned Storage</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/introduction">Documentation</a><a class="navbar__item navbar__link" href="/docs/community/support">Community</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/westerndigitalcorporation/zonedstorage.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/introduction">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/getting-started">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/linux">Linux Kernel Support</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/overview">Linux Kernel Zoned Storage Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/config">Kernel Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/zbd-api">Zoned Block Device User Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/linux/sched">Write Ordering Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux/part">Zoned Block Device Partition Support</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/device-mapper">Device Mapper</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/filesystems">File Systems</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/applications">Applications</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/tools">Tools and Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/tests">System Compliance Tests</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/benchmarking">Performance Benchmarking</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/distributions/overview">Linux Distributions</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">Frequently Asked Questions</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Linux Kernel Support</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Write Ordering Control</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Write Ordering Control</h1></header>
<p>Historically, the Linux® kernel block I/O stack (i.e., the block layer and
the SCSI layer) have never guaranteed the exact execution order of block I/O
requests. The exact processing order of block I/O requests cannot be guaranteed
due to the asynchronous nature of the execution in the kernel of block I/O
requests and the necessity of a fine-granularity locking model for the device
request queue,  to minimize lock-contention overhead when multiple contexts
simultaneously issue I/O requests to a block device.</p>
<p>A direct result of this design is the inability to give guarantees to a well-
behaving zoned block device compliant application that write commands for a zone
will be delivered sequentially in increasing LBA order (matching the zone
sequential write constraint).</p>
<p>To address this problem, the kernel zoned block device support implements
either <em>zone write locking</em>  or <em>zone write plugging</em> to ensure that write
requests are processed sequentially per zone.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="zone-write-locking">Zone Write Locking<a href="#zone-write-locking" class="hash-link" aria-label="Direct link to Zone Write Locking" title="Direct link to Zone Write Locking">​</a></h2>
<p>Zone write locking implements a per-zone write lock to serialize the execution
of write requests that target the same zone. This feature does not guarantee
that write commands are always issued at the location of the zone write
pointer: this is the responsibility of the write I/O issuer. Zone write
locking only guarantees that the order in which write commands are issued
by an application, file system, or device mapper target will be respected by
the block I/O stack. A well-behaved user of zoned block devices will thus
avoid unaligned write command failures.</p>
<p>Zone write locking does not affect read commands in any way. Read requests are
not serialized and processed in exactly the same manner as with regular block
devices.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="initial-implementation">Initial Implementation<a href="#initial-implementation" class="hash-link" aria-label="Direct link to Initial Implementation" title="Direct link to Initial Implementation">​</a></h3>
<p>Zone write locking was first implemented in kernel 4.10 in the SCSI disk
driver (below the block layer), operating on requests already passed to the
device dispatch queue by the block I/O scheduler.</p>
<p>This early implementation relied on the fact that the SCSI layer could delay
issuing any request to the device. By maintaining a bitmap with one bit per
zone, the SCSI disk driver marked a zone as <em>locked</em> whenever it saw a write
command. This algorithm is presented here in more detail:</p>
<ol>
<li>
<p>If the next command to be dispatched to the device is not a write command,
then the command is dispatched immediately.</p>
</li>
<li>
<p>If the next command to by dispatched is a write command, then the zone
write lock bit for the target zone of the command is inspected.</p>
<ol type="a"><li><p>If the target zone of the write command is not write locked (i.e., the
bit is not set), then the zone is locked and the write command issued
to the device.  Both operations are atomically executed under the
device request queue spinlock.</p></li><li><p>If the target zone is already locked (i.e., the bit is set), then the
SCSI disk driver temporarily delays issuing the command to the device
until the zone write lock is released.</p></li><li><p>When a write command completes, the zone write lock for the target zone
of the command is released and the dispatch process is resumed. This
means that if the command at the head of the dispatch queue targets the
same zone, then the command can be issued (when the write command
completes) (step 2.a).</p></li></ol>
</li>
</ol>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Zone write locking that is implemented as shown above also prevents the
unintended reordering of commands by the SAS HBAs or SATA adapters. The <em>AHCI</em>
specifications do not define a clear order for issuing commands to devices. As a
result, many chipsets are unable to guarantee the proper order of commands.</p></div></div>
<p>Although this implementation provides write-ordering guarantees for the legacy
single-queue block I/O path and is not dependent upon any particular HBA, it
has several limitations:</p>
<ul>
<li>
<p><strong>Potential performance degradation</strong> Any write command to any zone results
in the command dispatch processing being stalled. This prevents all other
command from being dispatched, including read commands. This can limit
performance benefits that can be obtained with device-level command
reordering when operating the device at high queue depth. The extreme case is
an application issuing a write stream to a zone with asynchronous I/O system
calls (e.g. <code>io_submit()</code>). In this case, the sequential write commands
would be queued in sequence in the device dispatch queue, resulting in the
drive being operated at a queue depth of one, one write command at a time.</p>
</li>
<li>
<p><strong>No support for the block multi-queue I/O path</strong> Unlike the legacy single
queue block I/O interface, the multi-queue block I/O implementation does not
heavily rely on the device queue spin-lock to process block I/O requests
issued by the disk users (applications or kernel components). This results in
potential block I/O request reordering happening before requests are passed
on to the device dispatch queue and the ineffectiveness of zone write
locking.</p>
</li>
</ul>
<p>These limitations led to the development of a new implementation of zone write
locking at a higher level in the I/O stack, using the block layer I/O
schedulers.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="improved-implementation-block-io-scheduler">Improved Implementation: Block I/O Scheduler<a href="#improved-implementation-block-io-scheduler" class="hash-link" aria-label="Direct link to Improved Implementation: Block I/O Scheduler" title="Direct link to Improved Implementation: Block I/O Scheduler">​</a></h3>
<p>By moving zone write locking implementation higher up in the I/O stack, the
block multi-queue (and SCSI multi-queue) infrastructure can also be supported.
This improvement was added with kernel version 4.16 and the SCSI layer
implementation of zone write locking was removed.</p>
<p>This new implementation of zone write locking relies on the block layer
<em>deadline</em> and <em>mq-deadline</em> I/O schedulers and also addresses the performance
limitations of the previous implementation. In detail, the new algorithm is as
follows.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The <em>deadline</em> and <em>mq-deadline</em> schedulers operate by grouping commands per
type (reads vs writes) and always processsing these two groups of commands
separately, e.g. first issuing many reads, then many writes. This improves
performance by taking advantage of hardware features such as device-level
read-ahead.</p></div></div>
<ol>
<li>
<p>If the scheduler is processing read commands...</p>
<ol type="a"><li><p>...the first command queued in the list of read commands is allowed to
proceed and is submitted to the device dispatch queue.</p></li><li><p>If no read commands are available, activate write processing (step 2).</p></li><li><p>If the read-command processing time limit is reached, write-command
processing (step 2) is activated to avoid write-command starvation.</p></li><li><p>If read commands are still available, restart at step 1.</p></li></ol>
</li>
<li>
<p>When processing write commands, the list of write commands queued in the
scheduler is scanned in order starting with the command at the head of the
LBA ordered list or the first command in the arrival-time ordered list (when
there is a risk of starving commands).</p>
<ol type="a"><li><p>If the target zone of the first write command is not write locked (zone
bitmap bit not set), then the zone is locked and the write command is
issued to the device. Both operations are atomically executed under a
spinlock maintained by the scheduler.</p></li><li><p>If the target zone is already locked (bit set), the command is skipped
and the first write command that targets a different zone is searched
for in the LBA ordered list of write commands. If such a command is
found, step 2 is executed again.</p></li><li><p>If all queued write commands target locked zones, the scheduler
operation mode (batch mode) is switched to <em>read</em> and step 1 is called.</p></li></ol>
</li>
<li>
<p>When a write command completes, the zone write lock for the target zone of
the command is released and the scheduler is activated. Operation is
resumed at step 1 or 2 depending on the current batch mode.</p>
</li>
</ol>
<p>From this algorithm, it is clear that the device can now be operated at higher
queue depth and that only sequential writes that target the same zone will be
throttled. All read commands can proceed, always, and write commands that
target different zones do not impact each other.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This new implementation does not guarantee overall command ordering.  Guarantees
are given only for write commands that target the same zone.  The dispatch order
of write commands that target different zones may be changed by the scheduler.
For any single sequential zone, at any time, there is always at most a single
write command in-flight being executed. Overall disk operation at high queue
depth is possible when there are read accesses and if multiple zones are being
written simultaneously.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="zone-write-plugging">Zone Write Plugging<a href="#zone-write-plugging" class="hash-link" aria-label="Direct link to Zone Write Plugging" title="Direct link to Zone Write Plugging">​</a></h2>
<p>Zone write plugging was introduced with kernel 6.10.0 as a replacement for zone
write locking. Zone write plugging is very similar in concept to zone write
locking: it limits the number of in-flight write I/O request to at most one per
zone to avoid breaking the sequential write pattern of the I/O issuer.</p>
<p>However, unlike zone write locking which is implemented in the <em>mq-deadline</em>
block I/O scheduler, zone write plugging is implemented directly in the upper
submission path of the block layer and thus does not depend on the block I/O
scheduler being used.</p>
<p>Zone write locking operates using a per-zone list of block I/O write requests
(BIOs) to throttle write operations to a zone. If a zone is not being written
already when a new write operation is submitted, the write request is executed
immediately. Otherwise, the new write request is added to the tail of the list
of write BIOs for the target zone. Upon completion of the in-flight write for
the zone, the first write BIO in the zone list is automatically issued, thus
always maintaining at most one write I/O per zone at any time.</p>
<p>Similarly to zone write locking, zone write plugging does not affect read
commands in any way. Read requests are not serialized using the per zone list of
BIO.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="block-io-scheduler-configuration">Block I/O Scheduler Configuration<a href="#block-io-scheduler-configuration" class="hash-link" aria-label="Direct link to Block I/O Scheduler Configuration" title="Direct link to Block I/O Scheduler Configuration">​</a></h2>
<p>The <em>deadline</em> and <em>mq-deadline</em> schedulers must be enabled in the kernel
compilation configuration for kernels that use zone write locking, that is,
kernels from version 4.16 up to version 6.9. From kernel 6.10 onward, the
<em>mq-deadline</em> scheduler can still be used for zoned block devices (e.g. SMR
HDDs) but is not a requirement for write ordering control.</p>
<p>Refer to the section
<a href="/docs/linux/config#write-ordering-control">Write Ordering Control</a> for details.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The legacy single queue block I/O path was removed from the kernel in version
5.0. As of kernel version 5.0, the <em>deadline</em> scheduler cannot be enabled. The
<em>mq-deadline</em> scheduler is the only zoned block device compliant scheduler for
kernels implementing zone write locking (kernel versions from 5.0 up to 6.9).</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="manual-configuration">Manual Configuration<a href="#manual-configuration" class="hash-link" aria-label="Direct link to Manual Configuration" title="Direct link to Manual Configuration">​</a></h3>
<p>A system may define a default I/O scheduler other than <em>deadline</em> or
<em>mq-deadline</em>. The block I/O scheduler for a zoned block device can be checked
with the following command.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/block/sdb/queue/scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[none] mq-deadline kyber bfq</span><br></span></code></pre></div></div>
<p>If the block I/O scheduler selected is not <em>deadline</em> nor <em>mq-deadline</em> as in
the example above, the scheduler can be changed with the following command.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># echo mq-deadline &gt; /sys/block/sdb/queue/scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cat sys/block/sdb/queue/scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[mq-deadline] kyber bfq none</span><br></span></code></pre></div></div>
<p><em>deadline</em> is an alias for the <em>mq-deadline</em> scheduler. The following command
can therefore be used to get the same results in environments that use the
legacy single queue I/O path (kernels 4.16 to 4.20) and environments that use
the block multi-queue infrastructure (the sole possibility as of kernel
version 5.0).</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># echo deadline &gt; /sys/block/sdb/queue/scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cat sys/block/sdb/queue/scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[mq-deadline] kyber bfq none</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="automatic-persistent-configuration">Automatic Persistent Configuration<a href="#automatic-persistent-configuration" class="hash-link" aria-label="Direct link to Automatic Persistent Configuration" title="Direct link to Automatic Persistent Configuration">​</a></h3>
<p>Automatically configuring the <em>deadline</em> scheduler at system boot time can
also be done using a <em>udev</em> rule. The procedure for defining a new <em>udev</em> rule
varies slightly between distributions. Refer to your distribution
documentation for details.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ACTION==&quot;add|change&quot;, KERNEL==&quot;sd*[!0-9]&quot;, ATTRS{queue/zoned}==&quot;host-managed&quot;, ATTR{queue/scheduler}=&quot;deadline&quot;</span><br></span></code></pre></div></div>
<p>This rule sets up the <em>deadline</em> scheduler for any host-managed zoned block
device found in the system. A host-aware zoned block disk can accept random
writes and thus tolerate occasional write reordering within a zone sequential
write stream. Nevertheless, write ordering can be maintained for these disks too
by using the <em>deadline</em> scheduler. The above <em>udev</em> rule modified will
automatically enable this.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ACTION==&quot;add|change&quot;, KERNEL==&quot;sd*[!0-9]&quot;, ATTRS{queue/zoned}==&quot;host-aware&quot;, ATTR{queue/scheduler}=&quot;deadline&quot;</span><br></span></code></pre></div></div>
<p>The following single rule enables the <em>deadline</em> scheduler for any zoned
block device, regardless of the device zone model.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ACTION==&quot;add|change&quot;, KERNEL==&quot;sd*[!0-9]&quot;, ATTRS{queue/zoned}!=&quot;none&quot;, ATTR{queue/scheduler}=&quot;deadline&quot;</span><br></span></code></pre></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/linux/zbd-api"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Zoned Block Device User Interface</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/linux/part"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Zoned Block Device Partition Support</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#zone-write-locking" class="table-of-contents__link toc-highlight">Zone Write Locking</a><ul><li><a href="#initial-implementation" class="table-of-contents__link toc-highlight">Initial Implementation</a></li><li><a href="#improved-implementation-block-io-scheduler" class="table-of-contents__link toc-highlight">Improved Implementation: Block I/O Scheduler</a></li></ul></li><li><a href="#zone-write-plugging" class="table-of-contents__link toc-highlight">Zone Write Plugging</a></li><li><a href="#block-io-scheduler-configuration" class="table-of-contents__link toc-highlight">Block I/O Scheduler Configuration</a><ul><li><a href="#manual-configuration" class="table-of-contents__link toc-highlight">Manual Configuration</a></li><li><a href="#automatic-persistent-configuration" class="table-of-contents__link toc-highlight">Automatic Persistent Configuration</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/zoned-storage">Introduction to Zoned Storage</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting Started with Zoned Storage</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://app.element.io/#/room/#zonedstorage-general:matrix.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Matrix<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/westerndigitalcorporation" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Organization<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Western Digital
	Corporation or its affiliates. All rights reserved.<br> By using this site, you agree to the <a href="https://www.westerndigital.com/legal/terms-of-use" target="_blank">Terms of Use</a> and <a href="https://www.westerndigital.com/legal/privacy-statement" target="_blank">Privacy Statement</a>.  All example scripts and program snippets on this site are licensed under the <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank">CCO 1.0 Universal</a> license.<br>This site is built with <a href="https://docusaurus.io/" target="_blank">Docusaurus</a>.</div></div></div></footer></div>
</body>
</html>