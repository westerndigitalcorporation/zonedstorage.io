<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-getting-started/zbd-emulation" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Getting started with Emulated Zoned Block Devices | Zoned Storage</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zonedstorage.io/docs/getting-started/zbd-emulation"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Getting started with Emulated Zoned Block Devices | Zoned Storage"><meta data-rh="true" name="description" content="Emulated zoned block devices make it possible to do application development and"><meta data-rh="true" property="og:description" content="Emulated zoned block devices make it possible to do application development and"><link data-rh="true" rel="icon" href="/img/zs-logo.ico"><link data-rh="true" rel="canonical" href="https://zonedstorage.io/docs/getting-started/zbd-emulation"><link data-rh="true" rel="alternate" href="https://zonedstorage.io/docs/getting-started/zbd-emulation" hreflang="en"><link data-rh="true" rel="alternate" href="https://zonedstorage.io/docs/getting-started/zbd-emulation" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0DX1KGD5E4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0DX1KGD5E4",{})</script><link rel="stylesheet" href="/assets/css/styles.5cd6be9b.css">
<script src="/assets/js/runtime~main.a43c05e2.js" defer="defer"></script>
<script src="/assets/js/main.5c9ead0e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/zs-logo.png" alt="Zoned Storage Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Zoned Storage</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/introduction">Documentation</a><a class="navbar__item navbar__link" href="/docs/community/support">Community</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/westerndigitalcorporation/zonedstorage.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/introduction">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/getting-started">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/linux">Setting-up a Zoned Storage Compatible Linux System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/getting-started/zbd-emulation">Getting started with Emulated Zoned Block Devices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/smr-disk">Getting Started with SMR Hard Disks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/zns-device">Getting Started with NVMe ZNS Devices</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/filesystems">File Systems</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/applications">Applications</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/tools">Tools and Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/linux">Linux Kernel Support</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/tests">System Compliance Tests</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/benchmarking">Performance Benchmarking</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/distributions/overview">Linux Distributions</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">Frequently Asked Questions</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Getting Started</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Getting started with Emulated Zoned Block Devices</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Zoned Block Device Emulation</h1>
<p>Emulated zoned block devices make it possible to do application development and
kernel tests even if you do not have access to zoned storage hardware.</p>
<p>There are several ways available to create an emulated zoned block device.</p>
<ol>
<li>
<p>The <em><strong>null_blk</strong></em> kernel block device driver: this is by far the easiest
method to emulate a zoned block device with different zone configurations
mimicking both SMR and ZNS devices.</p>
</li>
<li>
<p>The <em><strong>scsi-debug</strong></em> kernel block device driver: this driver is simple to
use but only makes it possible to create emulated SCSI ZBC hard disks.</p>
</li>
<li>
<p>The <em><strong>tcmu-runner</strong></em> SCSI device emulation: this application uses a regular
file as its storage backstore. It can emulate host-aware and host-managed
ZBC SCSI disks. Disks created with <em>tcmu-runner</em> are treated by the Linux
kernel as though they were physical disks.</p>
</li>
<li>
<p>The <em><strong>QEMU</strong></em> open source machine emulator and virtualizer: recent versions
of QEMU support the emulation of NVMe Zoned Namespaces devices. These use
regular files on the host as a backstores. Within a guest VM, an emulated
ZNS device acts like a physical device.</p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="zoned-block-device-emulation-with-null_blk">Zoned Block Device Emulation with <em>null_blk</em><a href="#zoned-block-device-emulation-with-null_blk" class="hash-link" aria-label="Direct link to zoned-block-device-emulation-with-null_blk" title="Direct link to zoned-block-device-emulation-with-null_blk">​</a></h2>
<p>The <a href="https://www.kernel.org/doc/Documentation/block/null_blk.txt" target="_blank" rel="noopener noreferrer">Linux® <em>null_blk</em>
driver</a> is a
powerful tool that can emulate several types of block devices. Since kernel
version 4.19, the <em>null_blk</em> driver has been able to emulate zoned block
devices. Because memory backup has been added to the <em>null_blk</em> device for
data-reading and data-writing operations, the <em>null_blk</em> driver can be used for
application development and tests.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-zoned-null-block-device--simplest-case">Creating a Zoned <em>null</em> Block Device — Simplest Case<a href="#creating-a-zoned-null-block-device--simplest-case" class="hash-link" aria-label="Direct link to creating-a-zoned-null-block-device--simplest-case" title="Direct link to creating-a-zoned-null-block-device--simplest-case">​</a></h3>
<p>The simplest way to create a <em>null_blk</em> emulated zoned block device is to
specify <code>zoned=1</code> as an argument following the <em>modprobe null_blk</em> command
on the command line, as in the following example:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># modprobe null_blk nr_devices=1 zoned=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This creates a single, host-managed zoned block device that has a zone size of
256M and a total capacity of 250 GB (1000 zones). This simple command creates
no conventional zones.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># blkzone report /dev/nullb0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000000000, len 0x080000, cap 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000080000, len 0x080000, cap 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000100000, len 0x080000, cap 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000180000, len 0x080000, cap 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x01f300000, len 0x080000, cap 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x01f380000, len 0x080000, cap 0x080000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="listing-null_blk-zoned-block-device-parameters">Listing <em>null_blk</em> Zoned Block Device Parameters<a href="#listing-null_blk-zoned-block-device-parameters" class="hash-link" aria-label="Direct link to listing-null_blk-zoned-block-device-parameters" title="Direct link to listing-null_blk-zoned-block-device-parameters">​</a></h3>
<p>The <em>null_blk</em> kernel module accepts many arguments that can adjust the zone
configuration of the emulated device. These arguments can be listed by using
the <em>modinfo</em> command and can be modified by using the <em>configfs</em> command after
the <em>null_blk</em> module is loaded.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># modinfo null_blk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parm:           zoned:Make device as a host-managed zoned block device. Default: false (bool)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parm:           zone_size:Zone size in MB when block device is zoned. Must be power-of-two: Default: 256 (ulong)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parm:           zone_capacity:Zone capacity in MB when block device is zoned. Can be less than or equal to zone size. Default: Zone size (ulong)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parm:           zone_nr_conv:Number of conventional zones when block device is zoned. Default: 0 (uint)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parm:           zone_max_open:Maximum number of open zones when block device is zoned. Default: 0 (no limit) (uint)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parm:           zone_max_active:Maximum number of active zones when block device is zoned. Default: 0 (no limit) (uint)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The parameters that are related to zoned-device emulation are shown in the table
below.</p>
<center><table><thead><tr><th style="text-align:left">Argument</th><th style="text-align:left">Value</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left">zoned</td><td style="text-align:left">0 or 1</td><td style="text-align:left">Disable or enable zoned mode (default: disabled)</td></tr><tr><td style="text-align:left">zone_size</td><td style="text-align:left">zone size in MiB</td><td style="text-align:left">The size of each zone (default: 256)</td></tr><tr><td style="text-align:left">zone_capacity</td><td style="text-align:left">zone capacity in MiB</td><td style="text-align:left">The capacity of each zone (default: zone size)</td></tr><tr><td style="text-align:left">zone_nr_conv</td><td style="text-align:left">number</td><td style="text-align:left">Number of conventional zones (default: 0)</td></tr><tr><td style="text-align:left">zone_max_open</td><td style="text-align:left">number</td><td style="text-align:left">Maximum number of open zones (default: 0, meaning no limit)</td></tr><tr><td style="text-align:left">zone_max_active</td><td style="text-align:left">number</td><td style="text-align:left">Maximum number of active zones (default: 0, meaning no limit)</td></tr></tbody></table></center>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-null_blk-zoned-block-device--more-advanced-cases-configfs">Creating a <em>null_blk</em> Zoned Block Device — More Advanced Cases (configfs)<a href="#creating-a-null_blk-zoned-block-device--more-advanced-cases-configfs" class="hash-link" aria-label="Direct link to creating-a-null_blk-zoned-block-device--more-advanced-cases-configfs" title="Direct link to creating-a-null_blk-zoned-block-device--more-advanced-cases-configfs">​</a></h3>
<p>To create an emulated zoned block device with <em>null_blk</em>, as shown above, the
<em>modprobe</em> command can be used. Additional parameters can be passed to this
command to configure the emulated disk.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># modprobe null_blk nr_devices=1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zoned=1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zone_nr_conv=4 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zone_size=64 \</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, the arguments mean the following:</p>
<ol>
<li><code>nr_devices=1</code> means that only one (1) device will be created.</li>
<li><code>zoned=1</code> means that all devices that are created will be zoned devices.</li>
<li><code>zone_nr_conv=4</code> sets the number of conventional zones to four (4).</li>
<li><code>zone_size=64</code> sets the size of each zone to sixty-four (64) megabytes.</li>
</ol>
<p>The <em>configfs</em> interface of the <em>null_blk</em> driver provides a way to create
emulated zoned block devices. The <em>configfs</em> parameters of the <em>null_blk</em>
driver can be listed by running the following commands:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># modprobe null_blk nr_devices=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/kernel/config/nullb/features</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memory_backed,discard,bandwidth,cache,badblocks,zoned,zone_size,zone_capacity,zone_nr_conv,zone_max_open,zone_max_active</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <em>configfs</em> interface can be used to script the creation of emulated zoned
block devices with a range of possible zone configurations. An example is
provided below.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ $# != 4 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;Usage: $0 &lt;sect size (B)&gt; &lt;zone size (MB)&gt; &lt;nr conv zones&gt; &lt;nr seq zones&gt;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scriptdir=$(cd $(dirname &quot;$0&quot;) &amp;&amp; pwd)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modprobe null_blk nr_devices=0 || return $?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function create_zoned_nullb()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local nid=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local bs=$1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local zs=$2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local nr_conv=$3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local nr_seq=$4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cap=$(( zs * (nr_conv + nr_seq) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while [ 1 ]; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if [ ! -b &quot;/dev/nullb$nid&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nid=$(( nid + 1 ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dev=&quot;/sys/kernel/config/nullb/nullb$nid&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mkdir &quot;$dev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo $bs &gt; &quot;$dev&quot;/blocksize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo 0 &gt; &quot;$dev&quot;/completion_nsec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo 0 &gt; &quot;$dev&quot;/irqmode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo 2 &gt; &quot;$dev&quot;/queue_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo 1024 &gt; &quot;$dev&quot;/hw_queue_depth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo 1 &gt; &quot;$dev&quot;/memory_backed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo 1 &gt; &quot;$dev&quot;/zoned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo $cap &gt; &quot;$dev&quot;/size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo $zs &gt; &quot;$dev&quot;/zone_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo $nr_conv &gt; &quot;$dev&quot;/zone_nr_conv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo 1 &gt; &quot;$dev&quot;/power</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo mq-deadline &gt; /sys/block/nullb$nid/queue/scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;$nid&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nulldev=$(create_zoned_nullb $1 $2 $3 $4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Created /dev/nullb$nulldev&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This script (<em>nullblk-zoned.sh</em>) takes four arguments:</p>
<ol>
<li>the sector size in bytes of the emulated device</li>
<li>the device zone size in MiB</li>
<li>the number of conventional zones (which can be 0)</li>
<li>the number of sequential write required zones.</li>
</ol>
<p>Memory-backing for written sectors can be turned on with this script (the
relevant part is <code>memory_backed=1</code> or, as it appears in this example,
<code>echo 1 &gt; &quot;$dev&quot;/memory_backed</code>). This enables runtime persistence of the
data written to the sectors of the emulated device. The writen data is lost when
the emulated device is destroyed.</p>
<p>For example, a small zoned device with 4 conventional zones and 8 sequential
write-required zones of 64 MiB can be created with the following command:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># nullblk-zoned.sh 4096 64 4 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created /dev/nullb0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># blkzone report /dev/nullb0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000000000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000020000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000040000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000060000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000080000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x0000a0000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x0000c0000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x0000e0000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000100000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000820000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000840000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000860000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deleting-a-null_blk-zoned-block-device">Deleting a <em>null_blk</em> Zoned Block Device<a href="#deleting-a-null_blk-zoned-block-device" class="hash-link" aria-label="Direct link to deleting-a-null_blk-zoned-block-device" title="Direct link to deleting-a-null_blk-zoned-block-device">​</a></h3>
<p>There are two ways to delete <em>null_blk</em> zoned block devices. One way is used to
delete <em>null_blk</em> zoned block devices that were created using <em>modprobe</em> and
the other way is used to delete <em>null_blk</em> zoned block devices that were
created using <em>configfs</em>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deleting-zbd-that-were-created-with-modprobe">Deleting ZBD that were created with modprobe<a href="#deleting-zbd-that-were-created-with-modprobe" class="hash-link" aria-label="Direct link to Deleting ZBD that were created with modprobe" title="Direct link to Deleting ZBD that were created with modprobe">​</a></h4>
<p>Emulated devices created by using <em>modprobe</em> (and not created using <em>configfs</em>)
can be deleted by removing the <em>null_blk</em> kernel module:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rmmod null_blk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This command does not delete emulated devices that were created through the
<em>configfs</em> interface.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deleting-zbd-that-were-created-with-configfs">Deleting ZBD that were created with configfs<a href="#deleting-zbd-that-were-created-with-configfs" class="hash-link" aria-label="Direct link to Deleting ZBD that were created with configfs" title="Direct link to Deleting ZBD that were created with configfs">​</a></h4>
<p>The following script is the counterpart of the zoned block device creation
script shown above. It can be used to destroy <em>null_blk</em> devices created
through <em>configfs</em>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ $# != 1 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	echo &quot;Usage: $0 &lt;nullb ID&gt;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nid=$1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ ! -b &quot;/dev/nullb$nid&quot; ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	echo &quot;/dev/nullb$nid: No such device&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo 0 &gt; /sys/kernel/config/nullb/nullb$nid/power</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmdir /sys/kernel/config/nullb/nullb$nid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Destroyed /dev/nullb$nid&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="emulating-smr-hdd">Emulating SMR HDD<a href="#emulating-smr-hdd" class="hash-link" aria-label="Direct link to Emulating SMR HDD" title="Direct link to Emulating SMR HDD">​</a></h3>
<p>The <em>nullblk-zoned.sh</em> script makes it possible to create zoned block devices
that correspond to a possible configuration of an SMR hard disk, with no limit
on the maximum number of open zones. This script can be modified to add a limit
to the number of open zones on the emulated device (the <em>zone_max_open</em>
parameter controls this), to more faithfully emulate an SMR HDD&#x27;s
characteristics.</p>
<p>The <em>zone_capacity</em> and <em>zone_max_active</em> parameters should not be used when the
emulated device is meant to mimic the characteristics of an SMR hard disk.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="emulating-nvme-zns-ssd">Emulating NVMe ZNS SSD<a href="#emulating-nvme-zns-ssd" class="hash-link" aria-label="Direct link to Emulating NVMe ZNS SSD" title="Direct link to Emulating NVMe ZNS SSD">​</a></h3>
<p>The <em>zone_capacity</em> and <em>zone_max_active</em> parameters make it possible to
create an emulated zoned block device that mimics the characteristics of a
NVMe Zoned Namespace SSD. The <em>zone_capacity</em> parameter is used to specify
the number of sectors in each zone that can be read and written. The
<em>zone_max_active</em> argument is used to specify a limit on the number of
zones that can be in the closed state, the implicit-open state, or the
explicit-open state.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="smr-hard-disk-emulation-with-scsi_debug">SMR Hard Disk Emulation with <em>scsi_debug</em><a href="#smr-hard-disk-emulation-with-scsi_debug" class="hash-link" aria-label="Direct link to smr-hard-disk-emulation-with-scsi_debug" title="Direct link to smr-hard-disk-emulation-with-scsi_debug">​</a></h2>
<p>The <em>scsi_debug</em> kernel module can be used to create emulated ZBC SCSI disks
that use memory backing to store data, which is written to sectors.
Because this method uses memory as a backing store, the creation of large disks
requires a host with a large amount of DRAM.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This method stores sector data using volatile memory. This means that the data
written to the emulated device will not survive the device&#x27;s destruction and the
data written to this emulated device will not survive a host reboot.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-an-emulated-zbc-disk">Creating an Emulated ZBC Disk<a href="#creating-an-emulated-zbc-disk" class="hash-link" aria-label="Direct link to Creating an Emulated ZBC Disk" title="Direct link to Creating an Emulated ZBC Disk">​</a></h3>
<p><em>scsi_debug</em> ZBC disks can be created using <em>modprobe</em> with arguments.  The
following is an example that creates a host managed ZBC disk with 16GiB
capacity, 64MiB zones, and 32 conventional zones.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># modprobe scsi_debug \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	max_luns=1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sector_size=4096 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	dev_size_mb=16384 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zbc=managed \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zone_size_mb=64 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zone_nr_conv=32</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After the disk has been created, it can be examined by using the <em>lsscsi</em>
command.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[11:0:0:0]   zbc     Linux    scsi_debug       0190  /dev/sdj   /dev/sg9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The vendor field of the disk is set to &quot;scsi_debug&quot;. The kernel messages
also show the process whereby this disk came online.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># dmesg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scsi_debug:sdebug_driver_probe: scsi_debug: trim poll_queues to 0. poll_q/nr_hw = (0/1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scsi host11: scsi_debug: version 0190 [20200710]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 dev_size_mb=16384, opts=0x0, submit_queues=1, statistics=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scsi 11:0:0:0: Direct-Access-ZBC Linux    scsi_debug       0190 PQ: 0 ANSI: 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: Power-on or device reset occurred</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: Attached scsi generic sg9 type 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: [sdj] Host-managed zoned block device</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: [sdj] 4194304 4096-byte logical blocks: (17.2 GB/16.0 GiB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: [sdj] Write Protect is off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: [sdj] Mode Sense: 5b 00 10 08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: [sdj] Write cache: enabled, read cache: enabled, supports DPO and FUA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: [sdj] Optimal transfer size 4194304 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: [sdj] 256 zones of 16384 logical blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:0:0: [sdj] Attached SCSI disk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verifying-the-emulated-disk">Verifying The Emulated Disk<a href="#verifying-the-emulated-disk" class="hash-link" aria-label="Direct link to Verifying The Emulated Disk" title="Direct link to Verifying The Emulated Disk">​</a></h3>
<p>The zone configuration of the emulated disk can be inspected by using
<a href="/docs/tools/libzbc"><em>libzbc</em></a>, <a href="/docs/tools/sg3utils"><em>sg3utils</em></a> and
<a href="/docs/tools/util-linux"><em>util-linux</em></a> tools.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="using-zbc_report_zones">Using zbc_report_zones<a href="#using-zbc_report_zones" class="hash-link" aria-label="Direct link to Using zbc_report_zones" title="Direct link to Using zbc_report_zones">​</a></h4>
<p>Use <a href="/docs/tools/libzbc#zone-information"><em>zbc_report_zones</em></a> to verify the
zone configuration of the newly-created emulated ZBC disk:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># zbc_report_zones /dev/sg9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Device /dev/sg9:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Vendor ID: Linux scsi_debug 0190</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SCSI ZBC device interface, Host-managed zone model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    33554432 512-bytes sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    4194304 logical blocks of 4096 B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    4194304 physical blocks of 4096 B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    17.180 GB capacity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Read commands are unrestricted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    4096 KiB max R/W size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Maximum number of open sequential write required zones: 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    256 zones from 0, reporting option 0x00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">256 / 256 zones:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00000: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 0, 131072 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00001: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 131072, 131072 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00002: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 262144, 131072 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00031: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 4063232, 131072 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00032: type 0x2 (Sequential-write-required), cond 0x1 (Empty), reset recommended 0, non_seq 0, sector 4194304, 131072 sectors, wp 4194304</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00033: type 0x2 (Sequential-write-required), cond 0x1 (Empty), reset recommended 0, non_seq 0, sector 4325376, 131072 sectors, wp 4325376</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00254: type 0x2 (Sequential-write-required), cond 0x1 (Empty), reset recommended 0, non_seq 0, sector 33292288, 131072 sectors, wp 33292288</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00255: type 0x2 (Sequential-write-required), cond 0x1 (Empty), reset recommended 0, non_seq 0, sector 33423360, 131072 sectors, wp 33423360</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="using-blkzone">Using blkzone<a href="#using-blkzone" class="hash-link" aria-label="Direct link to Using blkzone" title="Direct link to Using blkzone">​</a></h4>
<p>Use <a href="/docs/tools/util-linux#zone-report"><em>blkzone</em></a> to verify the zone
configuration of the newly-created emulated ZBC disk. This displays the same
information that is returned by &quot;zbc_report_zones&quot;, but it is displayed in a
different format:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># blkzone report /dev/sdj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000000000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000020000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000040000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x0003e0000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000400000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000420000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x001fc0000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x001fe0000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="smr-hard-disk-emulation-with-tcmu-runner">SMR Hard Disk Emulation with <em>tcmu-runner</em><a href="#smr-hard-disk-emulation-with-tcmu-runner" class="hash-link" aria-label="Direct link to smr-hard-disk-emulation-with-tcmu-runner" title="Direct link to smr-hard-disk-emulation-with-tcmu-runner">​</a></h2>
<p>Detailed information on how to install and operate <em>tcmu-runner</em> can be found
in the <a href="/docs/tools/tcmu-runner">tcmu-runner ZBC Disk Emulation</a> chapter of
the <a href="/docs/tools">Tools and Libraries</a> Guide.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tcmu-runner-zbc-file-handler">tcmu-runner ZBC File Handler<a href="#tcmu-runner-zbc-file-handler" class="hash-link" aria-label="Direct link to tcmu-runner ZBC File Handler" title="Direct link to tcmu-runner ZBC File Handler">​</a></h3>
<p>The <em>ZBC file handler</em> is an internal device handler of <em>tcmu-runner</em> that
emulates a ZBC SCSI disk and uses a file as a backstore. The <em>tcmu-runner</em>
infrastructure connects the emulated disk to a virtual HBA that has been
implemented as a kernel driver. This structure provides a command path for the
emulated disk that is identical to the command path that would be available if a
physical disk were in its place. Applications and kernel components will not
perceive any difference.</p>
<p>The <a href="/docs/tools/tcmu-runner">tcmu-runner ZBC Disk Emulation</a> chapter of the
<a href="/docs/tools">Tools and Libraries</a> guide describes in more
detail the options available for creating emulated disks. These include the disk
zone model, the disk zone size, the disk capacity, and the number of
conventional zones of the disk.</p>
<p>The following example shows how to create a small (20 GB) host-managed ZBC disk
that has 10 conventional zones and a 256 MiB zone size. In this example, the
emulated disk capacity is stored in the file <em>/var/local/zbc0.raw</em>.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># targetcli</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">targetcli shell version 2.1.fb49</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copyright 2011-2013 by Datera, Inc and others.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For help on commands, type &#x27;help&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/&gt; cd /backstores/user:zbc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/backstores/user:zbc&gt; create name=zbc0 size=20G cfgstring=model-HM/zsize-256/conv-10@/var/local/zbc0.raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created user-backed storage object zbc0 size 21474836480.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/backstores/user:zbc&gt; cd /loopback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/loopback&gt; create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created target naa.500140529100d742.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/loopback&gt; cd naa.500140529100d742/luns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/loopback/naa...9100d742/luns&gt; create /backstores/user:zbc/zbc0 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created LUN 0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/loopback/naa...9100d742/luns&gt; cd /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/&gt; ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">o- / ..................................................................... [...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- backstores .......................................................... [...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- block .............................................. [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- fileio ............................................. [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- pscsi .............................................. [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- ramdisk ............................................ [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- user:fbo ........................................... [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- user:poma .......................................... [Storage Objects: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- user:zbc ........................................... [Storage Objects: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |   o- zbc0  [model-HM/zsize-256/conv-10@/var/local/zbc0.raw (20.0GiB) activated]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     o- alua ............................................... [ALUA Groups: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |       o- default_tg_pt_gp ................... [ALUA state: Active/optimized]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- iscsi ........................................................ [Targets: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- loopback ..................................................... [Targets: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | o- naa.500140529100d742 ............................. [naa.50014059e05d5424]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |   o- luns ........................................................ [LUNs: 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     o- lun0 ................................. [user/zbc0 (default_tg_pt_gp)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  o- vhost ........................................................ [Targets: 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/&gt; exit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verifying-the-emulated-disk-1">Verifying The Emulated Disk<a href="#verifying-the-emulated-disk-1" class="hash-link" aria-label="Direct link to Verifying The Emulated Disk" title="Direct link to Verifying The Emulated Disk">​</a></h3>
<p>You can verify that the emulated disk has been identified and initialized by
the kernel in the same way that you verify the kernel identification and
initialization of Serial ATA disks and SAS disks, as discussed in the <a href="/docs/getting-started/smr-disk">Getting
started with an SMR disk</a> chapter.</p>
<p>Identify the emulated disk by looking at the disk vendor ID that is displayed
by the <em>lsscsi</em> utility:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2:0:0:0]    disk    ATA      INTEL SSDSC2CT18 335u  /dev/sda   /dev/sg0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[5:0:0:0]    zbc     ATA      HGST HSH721415AL T220  /dev/sdb   /dev/sg1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[11:0:1:0]   zbc     LIO-ORG  TCMU ZBC device  0002  /dev/sdc   /dev/sg2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, the emulated disk is listed with the device vendor name
&quot;LIO-ORG&quot; and the device model name is &quot;TCMU ZBC device&quot;.</p>
<p>As with physical ZBC and ZAC disks, the kernel messages will show that the
drive has been identified and initialized:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># dmesg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scsi host11: TCM_Loopback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scsi 11:0:1:0: Direct-Access-ZBC LIO-ORG  TCMU ZBC device  0002 PQ: 0 ANSI: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: Attached scsi generic sg2 type 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sdc] Host-managed zoned block device</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sdc] 41943040 512-byte logical blocks: (21.5 GB/20.0 GiB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sdc] 80 zones of 524288 logical blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sdc] Write Protect is off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sdc] Mode Sense: 0f 00 00 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sdc] Write cache: enabled, read cache: enabled, doesn&#x27;t support DPO or FUA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sdc] Optimal transfer size 65536 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sd 11:0:1:0: [sdc] Attached SCSI disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The kernel identifies the emulated disk in the same way that it would identify
a physical SAS host managed disk (that is, with the device type
&quot;<em>Direct-Access-ZBC</em>&quot;).</p>
<p>The emulated disk can now be used in the same manner as any physical disk. For
instance, the <em>blkzone</em> or <em>zbc_report_zones</em> utilities can be used to inspect
the disk zone configuration:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># zbc_report_zones /dev/sdc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Device /dev/sdc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Vendor ID: LIO-ORG TCMU ZBC device 0002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Zoned block device interface, Host-managed zone model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    41943040 512-bytes sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    41943040 logical blocks of 512 B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    41943040 physical blocks of 512 B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    21.475 GB capacity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Read commands are unrestricted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Maximum number of open sequential write required zones: 35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    80 zones from 0, reporting option 0x00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">80 / 80 zones:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00000: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 0, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00001: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 524288, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00002: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 1048576, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00003: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 1572864, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00004: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 2097152, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00005: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 2621440, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00006: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 3145728, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00007: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 3670016, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00008: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 4194304, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00009: type 0x1 (Conventional), cond 0x0 (Not-write-pointer), sector 4718592, 524288 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00010: type 0x2 (Sequential-write-required), cond 0x1 (Empty), reset recommended 0, non_seq 0, sector 5242880, 524288 sectors, wp 5242880</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00011: type 0x2 (Sequential-write-required), cond 0x1 (Empty), reset recommended 0, non_seq 0, sector 5767168, 524288 sectors, wp 5767168</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00078: type 0x2 (Sequential-write-required), cond 0x1 (Empty), reset recommended 0, non_seq 0, sector 40894464, 524288 sectors, wp 40894464</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 00079: type 0x2 (Sequential-write-required), cond 0x1 (Empty), reset recommended 0, non_seq 0, sector 41418752, 524288 sectors, wp 41418752</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="nvme-zoned-namespace-device-emulation-with-qemu">NVMe Zoned Namespace Device Emulation with <em>QEMU</em><a href="#nvme-zoned-namespace-device-emulation-with-qemu" class="hash-link" aria-label="Direct link to nvme-zoned-namespace-device-emulation-with-qemu" title="Direct link to nvme-zoned-namespace-device-emulation-with-qemu">​</a></h2>
<p><em><a href="https://www.qemu.org/" target="_blank">QEMU</a></em> has supported the
emulation of NVMe namespaces since version 1.6. But the emulation of zoned
namespaces has been supported only since version 6.0 of <em>QEMU</em>. If the host
Linux distribution does not provide <em>QEMU</em> version 6.0 or above, <em>QEMU</em> has
to be compiled from source. Detailed information on how to compile and install
<em>QEMU</em> from source can be found <a href="https://www.qemu.org/download/#source" target="_blank">on the QEMU download page</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-an-emulated-zoned-namespace">Creating an Emulated Zoned Namespace<a href="#creating-an-emulated-zoned-namespace" class="hash-link" aria-label="Direct link to Creating an Emulated Zoned Namespace" title="Direct link to Creating an Emulated Zoned Namespace">​</a></h3>
<p>To create an emulated zoned namespace, you must first have a backing-store file
that the namespace can use. The size of the file determines the capacity of the
namespace that will be seen from the guest OS running in the <em>QEMU</em> virtual
machine.</p>
<p>For example: to create a 32GiB zoned namespace, you must first create a 32 GiB
file on the host. This can be done by using the <em>truncate</em> command to
create a sparse file or by using the <em>dd</em> command to create a fully allocated
file.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="creating-the-backstore">Creating the Backstore<a href="#creating-the-backstore" class="hash-link" aria-label="Direct link to Creating the Backstore" title="Direct link to Creating the Backstore">​</a></h4>
<p>This guide provides instructions for two methods of creating the backstore file:</p>
<ol>
<li>Using truncate</li>
<li>Using dd</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="using-truncate-to-create-an-emulated-zone-namespace-backstore">Using truncate to create an Emulated Zone Namespace Backstore<a href="#using-truncate-to-create-an-emulated-zone-namespace-backstore" class="hash-link" aria-label="Direct link to Using truncate to create an Emulated Zone Namespace Backstore" title="Direct link to Using truncate to create an Emulated Zone Namespace Backstore">​</a></h5>
<p>Run the following command to use <code>truncate</code> to create a backstore file:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># truncate -s 32G /var/lib/qemu/images/zns.raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ls -l /var/lib/qemu/images/zns.raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 34359738368 Jun 21 15:13 /var/lib/qemu/images/zns.raw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="using-dd-to-create-an-emulated-zone-namespace-backstore">Using dd to create an Emulated Zone Namespace Backstore<a href="#using-dd-to-create-an-emulated-zone-namespace-backstore" class="hash-link" aria-label="Direct link to Using dd to create an Emulated Zone Namespace Backstore" title="Direct link to Using dd to create an Emulated Zone Namespace Backstore">​</a></h5>
<p>Run the following command to use <code>dd</code> to create a backstore file:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># dd if=/dev/zero of=/var/lib/qemu/images/zns.raw bs=1M count=32768</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">32768+0 records in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">32768+0 records out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">34359738368 bytes (34 GB, 32 GiB) copied, 11.4072 s, 3.0 GB/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ls -l /var/lib/qemu/images/zns.raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 34359738368 Jun 22 11:22 /var/lib/qemu/images/zns.raw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-zns-and-using-the-backstore-file">Creating a ZNS and using the Backstore File<a href="#creating-a-zns-and-using-the-backstore-file" class="hash-link" aria-label="Direct link to Creating a ZNS and using the Backstore File" title="Direct link to Creating a ZNS and using the Backstore File">​</a></h4>
<p>Execute <em>QEMU</em> with command-line options and arguments to create a zoned
namespace that uses the backstore file as storage. In the following example,
the backstore file is used to emulate a zoned namespace that has zones of 64
MiB and a zone capacity of 62 MiB. The namespace block size is 4096 B.  The
namespace is set to allow at most 16 open zones and 32 active zones.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># /usr/local/bin/qemu-system-x86_64 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device nvme,id=nvme0,serial=deadbeef,zoned.zasl=5 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-drive file=${znsimg},id=nvmezns0,format=raw,if=none \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device nvme-ns,drive=nvmezns0,bus=nvme0,nsid=1,logical_block_size=4096,\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">physical_block_size=4096,zoned=true,zoned.zone_size=64M,zoned.\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zone_capacity=62M,zoned.max_open=16,zoned.max_active=32,\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uuid=5e40ec5f-eeb6-4317-bc5e-c919796a5f79</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verifying-an-emulated-zoned-namespace">Verifying an Emulated Zoned Namespace<a href="#verifying-an-emulated-zoned-namespace" class="hash-link" aria-label="Direct link to Verifying an Emulated Zoned Namespace" title="Direct link to Verifying an Emulated Zoned Namespace">​</a></h3>
<p>If your guest operating system is a Linux distribution and the Linux
distribution&#x27;s kernel version is higher than 5.9.0, the emulated NVMe ZNS
device can be checked by using the <em>nvme</em> command (see <a href="/docs/tools/zns">Linux Tools for
ZNS</a>.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># nvme list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node             SN                   Model                                    Namespace Usage                      Format           FW Rev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/nvme0n1     deadbeef             QEMU NVMe Ctrl                           1          34.36  GB /  34.36  GB      4 KiB +  0 B   1.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <em>lsscsi</em> utility shows the emulated NVMe device:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># lsscsi -g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2:0:0:0]    cd/dvd  QEMU     QEMU DVD-ROM     2.5+  /dev/sr0   /dev/sg0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[N:0:0:1]    disk    QEMU NVMe Ctrl__1                          /dev/nvme0n1  -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using the <em>blkzone</em> utility, the namespace zone configuration can be inspected.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># blkzone report /dev/nvme0n1 | less</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000000000, len 0x020000, cap 0x01f000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000020000, len 0x020000, cap 0x01f000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000040000, len 0x020000, cap 0x01f000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000060000, len 0x020000, cap 0x01f000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x000080000, len 0x020000, cap 0x01f000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x003f80000, len 0x020000, cap 0x01f000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x003fa0000, len 0x020000, cap 0x01f000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x003fc0000, len 0x020000, cap 0x01f000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start: 0x003fe0000, len 0x020000, cap 0x01f000, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The total number of zones of the namespace directly depends on the size of the
backstore file used and on the zone size configured. In the above example, the
emulated namespace has 512 zones (32 GiB / 64 MiB).</p></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/block/nvme0n1/queue/nr_zones </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">512</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the emulated namespace is configured with a zone capacity smaller than the
zone size, the total capacity defined by the backstore file will not be
usable. The effective usable capacity can be reported using <em>blkzone</em> with the
<em>capacity</em> command, as shown here:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># blkzone capacity /dev/nvme0n1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x003e00000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this case, the namespace&#x27;s effective storage capacity is 0x003e00000
(65011712) 512-Byte sectors, which is equivalent to 512 zones of 62 MiB
capacity.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-an-emulated-zoned-namespace">Using an Emulated Zoned Namespace<a href="#using-an-emulated-zoned-namespace" class="hash-link" aria-label="Direct link to Using an Emulated Zoned Namespace" title="Direct link to Using an Emulated Zoned Namespace">​</a></h3>
<p>The behavior of a <em>QEMU</em>-emulated NVMe ZNS device is fully compliant with the
NVMe ZNS specifications, with one exception: the state of namespace zones is
not persistent across restarts of the <em>QEMU</em> emulation. The state of zones is
preserved only as long as <em>QEMU</em> is running, even if the guest operating system
is rebooted. If <em>QEMU</em> is restarted and the same backstore file is used, then
the guest operating system will see the namespace with all zones in the empty
state.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="emulated-zoned-namespace-options">Emulated Zoned Namespace Options<a href="#emulated-zoned-namespace-options" class="hash-link" aria-label="Direct link to Emulated Zoned Namespace Options" title="Direct link to Emulated Zoned Namespace Options">​</a></h3>
<p>The implementation of NVMe device emulation and ZNS namespace emulation in
<em>QEMU</em> provides several configuration options to control the characteristics of
the device. The full list of options and parameters is
documented <a href="https://qemu-project.gitlab.io/qemu/system/nvme.html" target="_blank">here</a>.</p>
<p>The options and parameters related to Zoned Namespaces are as follows.</p>
<center><table><thead><tr><th style="text-align:left">Option</th><th style="text-align:left">Default Value</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left">zoned.zasl=UINT32</td><td style="text-align:left">0</td><td style="text-align:left">Zone Append Size Limit. If left at the default (0), the zone append size limit will be equal to the maximum data transfer size (MDTS). Otherwise, the zone append size limit is equal to 2 to the power of zasl multiplied by the minimum memory page size (4096 B), but cannot exceed the maximum data transfer size.</td></tr><tr><td style="text-align:left">zoned.zone_size=<em>SIZE</em></td><td style="text-align:left">128MiB</td><td style="text-align:left">Define the zone size (ZSZE)</td></tr><tr><td style="text-align:left">zoned.zone_capacity=<em>SIZE</em></td><td style="text-align:left">0</td><td style="text-align:left">Define the zone capacity (ZCAP). If left at the default (0), the zone capacity will equal the zone size.</td></tr><tr><td style="text-align:left">zoned.descr_ext_size=<em>UINT32</em></td><td style="text-align:left">0</td><td style="text-align:left">Set the Zone Descriptor Extension Size (ZDES). Must be a multiple of 64 bytes.</td></tr><tr><td style="text-align:left">zoned.cross_read=<em>BOOL</em></td><td style="text-align:left">off</td><td style="text-align:left">Set to &quot;on&quot; to allow reads to cross zone boundaries.</td></tr><tr><td style="text-align:left">zoned.max_active=<em>UINT32</em></td><td style="text-align:left">0</td><td style="text-align:left">Set the maximum number of active resources (MAR). The default (0) allows all zones to be active.</td></tr><tr><td style="text-align:left">zoned.max_open=<em>UINT32</em></td><td style="text-align:left">0</td><td style="text-align:left">Set the maximum number of open resources (MOR).  The default (0) allows all zones to be open. If <code>zoned.max_active</code> is specified, this value must be less than or equal to that.</td></tr></tbody></table></center>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="qemu-execution-example"><em>QEMU</em> Execution Example<a href="#qemu-execution-example" class="hash-link" aria-label="Direct link to qemu-execution-example" title="Direct link to qemu-execution-example">​</a></h3>
<p>The following script uses <em>QEMU</em> to run a virtual machine with 8 CPU cores,
16 GiB of memory, and bridged networking. The bridge device <em>virbr0</em> is assumed
already to exist. The last device added to the virtual machine on the <em>QEMU</em>
command line is a 32 GiB NVMe ZNS device.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Some variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bridge=&quot;virbr0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vmimg=&quot;/var/lib/qemu/boot-disk.qcow2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">znsimg=&quot;/var/lib/qemu/zns.raw&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Run QEMU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo /usr/local/bin/qemu-system-x86_64 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-name guest=FedoraServer34 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-machine pc-q35-5.2,accel=kvm \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-m 16384 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-smp 8,sockets=8,cores=1,threads=1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rtc base=utc,driftfix=slew \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-nographic \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-no-hpet \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-global ICH9-LPC.disable_s3=1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-global ICH9-LPC.disable_s4=1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-boot strict=on \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-audiodev none,id=noaudio \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-object rng-random,id=objrng0,filename=/dev/urandom \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-msg timestamp=on \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device pcie-root-port,port=0x10,chassis=1,id=pci.1,bus=pcie.0,multifunction=on,addr=0x2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-netdev bridge,id=hostnet0,br=${bridge} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:fa:2d:b9,bus=pci.1,addr=0x0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device pcie-root-port,port=0x11,chassis=2,id=pci.2,bus=pcie.0,addr=0x2.0x1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-blockdev node-name=&quot;vmstorage&quot;,driver=qcow2,file.driver=file,file.filename=&quot;${vmimg}&quot;,file.node-name=&quot;vmstorage.qcow2&quot;,file.discard=unmap \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device virtio-blk-pci,bus=pci.2,addr=0x0,drive=&quot;vmstorage&quot;,id=virtio-disk0,bootindex=1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device pcie-root-port,port=0x12,chassis=3,id=pci.3,bus=pcie.0,addr=0x2.0x2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device virtio-balloon-pci,id=balloon0,bus=pci.3,addr=0x0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device pcie-root-port,port=0x13,chassis=4,id=pci.4,bus=pcie.0,addr=0x2.0x3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device virtio-rng-pci,rng=objrng0,id=rng0,bus=pci.4,addr=0x0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device pcie-root-port,port=0x14,chassis=5,id=pci.5,bus=pcie.0,addr=0x2.0x4 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device nvme,id=nvme0,serial=deadbeef,zoned.zasl=5,bus=pci.5 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-drive file=${znsimg},id=nvmezns0,format=raw,if=none \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-device nvme-ns,drive=nvmezns0,bus=nvme0,nsid=1,logical_block_size=4096,physical_block_size=4096,zoned=true,zoned.zone_size=64M,zoned.zone_capacity=62M,zoned.max_open=16,zoned.max_active=32,uuid=5e40ec5f-eeb6-4317-bc5e-c919796a5f79</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/getting-started/linux"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Setting-up a Zoned Storage Compatible Linux System</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/getting-started/smr-disk"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Getting Started with SMR Hard Disks</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#zoned-block-device-emulation-with-null_blk" class="table-of-contents__link toc-highlight">Zoned Block Device Emulation with <em>null_blk</em></a><ul><li><a href="#creating-a-zoned-null-block-device--simplest-case" class="table-of-contents__link toc-highlight">Creating a Zoned <em>null</em> Block Device — Simplest Case</a></li><li><a href="#listing-null_blk-zoned-block-device-parameters" class="table-of-contents__link toc-highlight">Listing <em>null_blk</em> Zoned Block Device Parameters</a></li><li><a href="#creating-a-null_blk-zoned-block-device--more-advanced-cases-configfs" class="table-of-contents__link toc-highlight">Creating a <em>null_blk</em> Zoned Block Device — More Advanced Cases (configfs)</a></li><li><a href="#deleting-a-null_blk-zoned-block-device" class="table-of-contents__link toc-highlight">Deleting a <em>null_blk</em> Zoned Block Device</a></li><li><a href="#emulating-smr-hdd" class="table-of-contents__link toc-highlight">Emulating SMR HDD</a></li><li><a href="#emulating-nvme-zns-ssd" class="table-of-contents__link toc-highlight">Emulating NVMe ZNS SSD</a></li></ul></li><li><a href="#smr-hard-disk-emulation-with-scsi_debug" class="table-of-contents__link toc-highlight">SMR Hard Disk Emulation with <em>scsi_debug</em></a><ul><li><a href="#creating-an-emulated-zbc-disk" class="table-of-contents__link toc-highlight">Creating an Emulated ZBC Disk</a></li><li><a href="#verifying-the-emulated-disk" class="table-of-contents__link toc-highlight">Verifying The Emulated Disk</a></li></ul></li><li><a href="#smr-hard-disk-emulation-with-tcmu-runner" class="table-of-contents__link toc-highlight">SMR Hard Disk Emulation with <em>tcmu-runner</em></a><ul><li><a href="#tcmu-runner-zbc-file-handler" class="table-of-contents__link toc-highlight">tcmu-runner ZBC File Handler</a></li><li><a href="#verifying-the-emulated-disk-1" class="table-of-contents__link toc-highlight">Verifying The Emulated Disk</a></li></ul></li><li><a href="#nvme-zoned-namespace-device-emulation-with-qemu" class="table-of-contents__link toc-highlight">NVMe Zoned Namespace Device Emulation with <em>QEMU</em></a><ul><li><a href="#creating-an-emulated-zoned-namespace" class="table-of-contents__link toc-highlight">Creating an Emulated Zoned Namespace</a></li><li><a href="#verifying-an-emulated-zoned-namespace" class="table-of-contents__link toc-highlight">Verifying an Emulated Zoned Namespace</a></li><li><a href="#using-an-emulated-zoned-namespace" class="table-of-contents__link toc-highlight">Using an Emulated Zoned Namespace</a></li><li><a href="#emulated-zoned-namespace-options" class="table-of-contents__link toc-highlight">Emulated Zoned Namespace Options</a></li><li><a href="#qemu-execution-example" class="table-of-contents__link toc-highlight"><em>QEMU</em> Execution Example</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/zoned-storage">Introduction to Zoned Storage</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting Started with Zoned Storage</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://app.element.io/#/room/#zonedstorage-general:matrix.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Matrix<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/zonedstorage/shared_invite/zt-uyfut5xe-nKajp9YRnEWqiD4X6RkTFw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://webchat.oftc.net/?channels=zonedstorage" target="_blank" rel="noopener noreferrer" class="footer__link-item">IRC @ OFTC<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/westerndigitalcorporation" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Organization<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Western Digital
	Corporation or its affiliates. All rights reserved.<br> By using this site, you agree to the <a href="https://www.westerndigital.com/legal/terms-of-use" target="_blank">Terms of Use</a> and <a href="https://www.westerndigital.com/legal/privacy-statement" target="_blank">Privacy Statement</a>.  All example scripts and program snippets on this site are licensed under the <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank">CCO 1.0 Universal</a> license.<br>This site is built with <a href="https://docusaurus.io/" target="_blank">Docusaurus</a>.</div></div></div></footer></div>
</body>
</html>